<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rumah Belajar Kelas 5 - Sekolah Dasar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        #chat-content::-webkit-scrollbar { width: 8px; }
        #chat-content::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .tab-button.active { border-color: #10b981; color: #10b981; font-weight: 600; }
        .material-iframe { width: 100%; height: 400px; border-radius: 0.5rem; border: 2px solid #e2e8f0; }
        .floating-chat { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .embed-responsive-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 0.5rem; }
        .embed-responsive-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, query, onSnapshot, getDoc, updateDoc, arrayUnion, deleteDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase functions
        window.collection = collection; window.doc = doc; window.setDoc = setDoc; window.query = query;
        window.onSnapshot = onSnapshot; window.getDoc = getDoc; window.updateDoc = updateDoc;
        window.arrayUnion = arrayUnion; window.deleteDoc = deleteDoc; window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig.apiKey) {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            
            const initAuth = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                } catch (error) {
                    console.error("Auth error:", error);
                }
            };

            onAuthStateChanged(window.auth, (user) => {
                window.currentUser = user;
                window.currentUserId = user?.uid;
                
                if (user) {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    window.startDataListeners();
                    window.renderApp();
                }
            });

            initAuth();
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="loading-overlay" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-xl font-semibold text-teal-600 animate-pulse">Memuat Rumah Belajar...</div>
    </div>

    <div id="app-container" class="hidden">
        <header class="bg-white shadow-lg sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
                <div class="flex flex-col sm:flex-row items-baseline gap-2 cursor-pointer" onclick="window.goBackToSubjects()">
                    <h1 class="text-3xl font-bold text-teal-600 flex items-center">
                        üè† Rumah Belajar Kelas 5
                    </h1>
                    <span class="text-sm text-gray-400 italic">Developed by Cikgu Tere</span>
                </div>
                <nav id="tabs" class="mt-4 sm:mt-0 flex space-x-2 border-b border-gray-200"></nav>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-8">
            <div id="content-container"></div>
        </main>

        <div class="floating-chat">
            <button id="chat-toggle" class="bg-blue-600 text-white p-4 rounded-full shadow-lg">üí¨</button>
        </div>

        <div id="chat-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-[1001]">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4 flex flex-col h-[500px]">
                <div class="p-4 bg-teal-600 text-white flex justify-between rounded-t-xl">
                    <h3 class="font-bold">Cikgu Tere ü§ñ</h3>
                    <button id="chat-close">‚úï</button>
                </div>
                <div id="chat-content" class="flex-grow p-4 overflow-y-auto space-y-4"></div>
                <div class="p-4 border-t flex">
                    <input type="text" id="chat-input" class="flex-grow p-2 border rounded-l" placeholder="Tanya sesuatu...">
                    <button id="chat-send" class="bg-teal-600 text-white px-4 rounded-r">Kirim</button>
                </div>
            </div>
        </div>

        <div id="generic-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-[2000]">
            <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-sm m-4 p-6"></div>
        </div>
    </div>

    <script>
        window.generateId = () => 'id-' + Math.random().toString(36).substr(2, 9);
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        window.appState = {
            activeTab: 'login', // Default to login tab
            isAdmin: false,
            subjects: [],
            attendance: [],
            studentProfile: JSON.parse(localStorage.getItem('student_profile')) || null,
            selectedSubjectId: null,
            selectedChapterId: null,
            selectedMaterialId: null,
        };

        window.startDataListeners = () => {
            if (window.db && !window.listenerActive && window.currentUser) {
                window.listenerActive = true;
                
                // Listen to subjects
                const qSub = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects');
                window.onSnapshot(qSub, (snap) => {
                    window.appState.subjects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    window.renderApp();
                });

                // Listen to attendance (for admin)
                const qAtt = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'attendance');
                window.onSnapshot(qAtt, (snap) => {
                    window.appState.attendance = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (window.appState.activeTab === 'admin' && window.appState.isAdmin) {
                        window.renderApp();
                    }
                });
            }
        };

        window.renderApp = () => {
            const tabsContainer = document.getElementById('tabs');
            if (!tabsContainer) return;

            const tabs = [
                { id: 'login', label: 'üëã Masuk' },
                { id: 'mapel', label: 'üìö Pelajaran' },
                { id: 'admin', label: 'üõ°Ô∏è Admin' },
                { id: 'bantuan', label: '‚ùì Bantuan' }
            ];
            tabsContainer.innerHTML = tabs.map(t => `
                <button onclick="window.switchTab('${t.id}')" class="px-4 py-2 border-b-2 ${window.appState.activeTab === t.id ? 'border-teal-600 text-teal-600 font-bold' : 'border-transparent text-gray-500'}">
                    ${t.label}
                </button>
            `).join('');

            const container = document.getElementById('content-container');
            if (!container) return;

            if (window.appState.activeTab === 'login') renderLoginSiswa(container);
            else if (window.appState.activeTab === 'mapel') renderMapel(container);
            else if (window.appState.activeTab === 'admin') window.appState.isAdmin ? renderAdmin(container) : renderLoginAdmin(container);
            else renderBantuan(container);
        };

        window.switchTab = (tab) => { 
            if (tab === 'mapel' && !window.appState.studentProfile) {
                window.showMod("Perhatian", "Silakan isi data diri/login terlebih dahulu di tab Masuk.", "error");
                window.appState.activeTab = 'login';
            } else {
                window.appState.activeTab = tab; 
            }
            window.renderApp(); 
        };

        window.goBackToSubjects = () => { window.appState.selectedSubjectId = null; window.appState.selectedChapterId = null; window.appState.selectedMaterialId = null; window.renderApp(); };

        function renderLoginSiswa(container) {
            if (window.appState.studentProfile) {
                container.innerHTML = `
                    <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow text-center">
                        <div class="text-5xl mb-4">‚úÖ</div>
                        <h2 class="text-2xl font-bold mb-2">Halo, ${window.appState.studentProfile.nama}!</h2>
                        <p class="text-gray-500 mb-6">Kamu sudah melakukan absensi dari <b>${window.appState.studentProfile.sekolah}</b>.</p>
                        <button onclick="window.switchTab('mapel')" class="w-full bg-teal-600 text-white p-3 rounded-lg font-bold shadow-lg hover:bg-teal-700 transition-all">Mulai Belajar Sekarang</button>
                        <button onclick="localStorage.removeItem('student_profile'); window.appState.studentProfile=null; window.renderApp();" class="mt-4 text-xs text-red-500 hover:underline">Ganti Identitas</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow">
                    <h2 class="text-2xl font-bold mb-2">Presensi Siswa</h2>
                    <p class="text-sm text-gray-500 mb-6">Lengkapi data di bawah untuk mencatat kehadiran dan mulai belajar.</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Nama Lengkap</label>
                            <input type="text" id="s-nama" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500 outline-none" placeholder="Masukkan nama kamu">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Asal Provinsi</label>
                            <input type="text" id="s-prov" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500 outline-none" placeholder="Contoh: Jawa Barat">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Asal Sekolah</label>
                            <input type="text" id="s-sekolah" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500 outline-none" placeholder="Nama SD kamu">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Kelas</label>
                            <select id="s-kelas" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500 outline-none">
                                <option value="5A">Kelas 5A</option>
                                <option value="5B">Kelas 5B</option>
                                <option value="5C">Kelas 5C</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <button onclick="window.submitLoginSiswa()" class="w-full bg-teal-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-teal-700 transition-all">Masuk & Belajar</button>
                    </div>
                </div>
            `;
        }

        window.submitLoginSiswa = async () => {
            const nama = document.getElementById('s-nama').value;
            const provinsi = document.getElementById('s-prov').value;
            const sekolah = document.getElementById('s-sekolah').value;
            const kelas = document.getElementById('s-kelas').value;

            if (!nama || !provinsi || !sekolah) {
                window.showMod("Data Kurang", "Harap isi semua kolom agar Cikgu bisa mengenalmu.", "error");
                return;
            }

            const profile = { nama, provinsi, sekolah, kelas, timestamp: new Date().toISOString() };
            
            try {
                // Save to Firestore
                const attRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'attendance');
                await window.addDoc(attRef, { ...profile, serverTime: window.serverTimestamp() });
                
                // Save to local
                localStorage.setItem('student_profile', JSON.stringify(profile));
                window.appState.studentProfile = profile;
                window.showMod("Berhasil Masuk!", `Selamat belajar, ${nama}!`, "success");
                window.renderApp();
            } catch (e) {
                console.error(e);
                window.showMod("Error", "Gagal menyimpan data absensi.", "error");
            }
        };

        function renderMapel(container) {
            if (window.appState.selectedMaterialId) return renderMaterialDetail(container);
            if (window.appState.selectedChapterId) return renderChapterDetail(container);
            if (window.appState.selectedSubjectId) return renderSubjectDetail(container);

            container.innerHTML = `<h2 class="text-2xl font-bold mb-6">Pilih Mata Pelajaran</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    ${window.appState.subjects.length === 0 ? '<p class="text-gray-500">Belum ada mata pelajaran.</p>' : ''}
                    ${window.appState.subjects.map(s => {
                        const chapterCount = s.chapters ? s.chapters.length : 0;
                        return `
                        <div onclick="window.appState.selectedSubjectId='${s.id}'; window.renderApp()" class="bg-white p-6 rounded-xl shadow hover:shadow-lg cursor-pointer border-b-4 border-teal-500 transition-all group">
                            <div class="text-4xl mb-2 group-hover:scale-110 transition-transform">${s.icon || 'üìö'}</div>
                            <div class="font-bold text-lg">${s.name}</div>
                            <div class="text-xs text-gray-400 mt-2 flex items-center">
                                <span class="bg-gray-100 px-2 py-1 rounded-md font-semibold">${chapterCount} Bab Materi</span>
                            </div>
                        </div>
                    `}).join('')}
                </div>`;
        }

        function renderSubjectDetail(container) {
            const subject = window.appState.subjects.find(s => s.id === window.appState.selectedSubjectId);
            if (!subject) return window.goBackToSubjects();

            container.innerHTML = `<button onclick="window.goBackToSubjects()" class="mb-4 text-teal-600 flex items-center hover:underline">‚Üê Kembali</button>
                <h2 class="text-2xl font-bold mb-6">${subject.icon} ${subject.name}</h2>
                <div class="space-y-3">
                    ${(!subject.chapters || subject.chapters.length === 0) ? '<p class="text-gray-500 italic">Belum ada bab yang ditambahkan.</p>' : ''}
                    ${(subject.chapters || []).map(c => `
                        <div onclick="window.appState.selectedChapterId='${c.id}'; window.renderApp()" class="bg-white p-4 rounded-lg shadow cursor-pointer hover:bg-teal-50 border border-gray-100 flex justify-between items-center transition-colors">
                            <span class="font-medium">${c.title}</span>
                            <span class="text-xs bg-teal-100 text-teal-700 px-2 py-1 rounded-full">${c.materials ? c.materials.length : 0} Konten</span>
                        </div>
                    `).join('')}
                </div>`;
        }

        function renderChapterDetail(container) {
            const subject = window.appState.subjects.find(s => s.id === window.appState.selectedSubjectId);
            const chapter = subject?.chapters?.find(c => c.id === window.appState.selectedChapterId);
            if (!chapter) { window.appState.selectedChapterId = null; return window.renderApp(); }

            container.innerHTML = `<button onclick="window.appState.selectedChapterId=null; window.renderApp()" class="mb-4 text-teal-600 flex items-center hover:underline">‚Üê Kembali ke Daftar Bab</button>
                <h2 class="text-2xl font-bold mb-6">${chapter.title}</h2>
                <div class="grid gap-4">
                    ${(!chapter.materials || chapter.materials.length === 0) ? '<p class="text-gray-500 italic">Belum ada materi di bab ini.</p>' : ''}
                    ${(chapter.materials || []).map(m => `
                        <div onclick="window.appState.selectedMaterialId='${m.id}'; window.renderApp()" class="bg-white p-4 rounded-lg shadow flex items-center cursor-pointer hover:bg-teal-50 border-l-4 ${getMColor(m.type)} transition-all">
                            <span class="mr-4 text-2xl">${getMIcon(m.type)}</span>
                            <div>
                                <div class="font-bold text-gray-800">${m.title}</div>
                                <div class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">${getMLabel(m.type)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        }

        function renderMaterialDetail(container) {
            const subject = window.appState.subjects.find(s => s.id === window.appState.selectedSubjectId);
            const chapter = subject?.chapters?.find(c => c.id === window.appState.selectedChapterId);
            const material = chapter?.materials?.find(m => m.id === window.appState.selectedMaterialId);
            if (!material) { window.appState.selectedMaterialId = null; return window.renderApp(); }
            
            container.innerHTML = `<button onclick="window.appState.selectedMaterialId=null; window.renderApp()" class="mb-4 text-teal-600 flex items-center hover:underline">‚Üê Kembali ke Materi</button>
                <h2 class="text-2xl font-bold mb-6">${material.title}</h2>
                <div class="bg-white p-6 rounded-xl shadow min-h-[400px]">
                    ${renderContent(material)}
                </div>`;
        }

        function renderLoginAdmin(container) {
            container.innerHTML = `<div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow">
                <h2 class="text-xl font-bold mb-4">Login Admin</h2>
                <p class="text-sm text-gray-500 mb-6">Silakan masukkan kata sandi akses pengelola untuk melanjutkan.</p>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Kata Sandi</label>
                    <input type="password" id="pw" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500 outline-none border-gray-300" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button onclick="if(document.getElementById('pw').value==='admin123'){window.appState.isAdmin=true; window.renderApp();}else{window.showMod('Gagal', 'Kata sandi yang Anda masukkan salah.', 'error');}" class="w-full bg-teal-600 text-white p-3 rounded-lg hover:bg-teal-700 transition-colors font-bold shadow-md">Masuk ke Panel Kontrol</button>
            </div>`;
        }

        function renderAdmin(container) {
            container.innerHTML = `
                <div class="mb-8 bg-white p-6 rounded-xl shadow border-t-4 border-yellow-500">
                    <h3 class="font-bold text-lg mb-4 flex justify-between items-center">
                        <span>üë• Data Presensi Siswa</span>
                        <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">${window.appState.attendance.length} Total</span>
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-gray-600 uppercase text-[10px] font-bold">
                                <tr>
                                    <th class="p-3">Waktu</th>
                                    <th class="p-3">Nama</th>
                                    <th class="p-3">Sekolah</th>
                                    <th class="p-3">Provinsi</th>
                                    <th class="p-3">Kelas</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${window.appState.attendance.length === 0 ? '<tr><td colspan="5" class="p-4 text-center text-gray-400">Belum ada data masuk.</td></tr>' : ''}
                                ${window.appState.attendance.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(att => `
                                    <tr>
                                        <td class="p-3 text-gray-400">${new Date(att.timestamp).toLocaleTimeString()}</td>
                                        <td class="p-3 font-bold">${att.nama}</td>
                                        <td class="p-3">${att.sekolah}</td>
                                        <td class="p-3">${att.provinsi}</td>
                                        <td class="p-3"><span class="bg-teal-50 text-teal-700 px-2 py-1 rounded-full text-[10px] font-bold">${att.kelas}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow border-t-4 border-blue-500">
                        <h3 class="font-bold text-lg mb-4 flex items-center"><span class="mr-2">üìÇ</span> Navigasi & Tambah Bab</h3>
                        
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Mata Pelajaran</label>
                        <select id="adm-sub" class="w-full p-2 border mb-4 rounded" onchange="window.handleSubChange()">
                            <option value="">-- Pilih Mapel --</option>
                            ${window.appState.subjects.map(s => `<option value="${s.id}" ${window.lastSelectedSubId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
                        </select>

                        <div id="adm-chapter-selection-area"></div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow border-t-4 border-teal-500">
                        <h3 class="font-bold text-lg mb-4 flex items-center"><span class="mr-2">‚öôÔ∏è</span> Kelola & Tambah Materi</h3>
                        <div id="materi-workspace">
                            <p class="italic text-gray-400">Silakan pilih Mapel dan Bab di sebelah kiri untuk mengelola materi.</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 bg-white p-6 rounded-xl shadow border-t-4 border-gray-200">
                    <h3 class="font-bold mb-4 flex items-center"><span class="mr-2">üìö</span> Master Data: Tambah Mata Pelajaran</h3>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input id="new-sub-name" class="border p-2 flex-grow rounded" placeholder="Nama Mapel (Contoh: Matematika)">
                        <input id="new-sub-icon" class="border p-2 w-full sm:w-24 rounded text-center" placeholder="Icon (üé®)">
                        <button onclick="window.addSub()" class="bg-teal-600 text-white px-6 py-2 rounded hover:bg-teal-700 font-bold">Tambah Mapel</button>
                    </div>
                </div>
            `;

            const subDropdown = document.getElementById('adm-sub');
            if (subDropdown && subDropdown.value) {
                window.handleSubChange(true);
            }
        }

        window.handleSubChange = (isInitial = false) => {
            const subDropdown = document.getElementById('adm-sub');
            if (!subDropdown) return;
            
            const subId = subDropdown.value;
            window.lastSelectedSubId = subId;
            const chapArea = document.getElementById('adm-chapter-selection-area');
            const workspace = document.getElementById('materi-workspace');

            if (!subId) {
                if(chapArea) chapArea.innerHTML = '';
                if(workspace) workspace.innerHTML = '<p class="italic text-gray-400">Silakan pilih Mapel dan Bab di sebelah kiri untuk mengelola materi.</p>';
                return;
            }

            const sub = window.appState.subjects.find(s => s.id === subId);
            if (chapArea && sub) {
                chapArea.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Bab</label>
                    <select id="adm-chap" class="w-full p-2 border mb-4 rounded" onchange="window.updateAdminManageList()">
                        <option value="">-- Pilih Bab --</option>
                        ${(sub.chapters || []).map(c => `<option value="${c.id}" ${window.lastSelectedChapId === c.id ? 'selected' : ''}>${c.title}</option>`).join('')}
                    </select>

                    <div class="bg-blue-50 p-4 rounded-lg mt-4 border border-blue-100">
                        <label class="block text-sm font-medium text-blue-800 mb-1">Atau Buat Bab Baru</label>
                        <div class="flex gap-2">
                            <input id="new-chap-name" class="flex-grow border p-2 rounded text-sm" placeholder="Nama Bab Baru">
                            <button onclick="window.addChap()" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm font-bold">Tambah</button>
                        </div>
                    </div>
                `;
            }

            if(window.lastSelectedChapId) {
                window.updateAdminManageList();
            }
        };

        window.updateAdminManageList = () => {
            const subDropdown = document.getElementById('adm-sub');
            const chapDropdown = document.getElementById('adm-chap');
            const workspace = document.getElementById('materi-workspace');
            
            if (!subDropdown || !chapDropdown || !workspace) return;

            const subId = subDropdown.value;
            const chapId = chapDropdown.value;
            window.lastSelectedChapId = chapId;

            if (!subId || !chapId) {
                workspace.innerHTML = `<p class="italic text-gray-400">Silakan pilih Mapel dan Bab di sebelah kiri untuk mengelola materi.</p>`;
                return;
            }

            const sub = window.appState.subjects.find(s => s.id === subId);
            const chap = sub?.chapters?.find(c => c.id === chapId);
            
            let materialsHtml = '';
            if (!chap || !chap.materials || chap.materials.length === 0) {
                materialsHtml = `<p class="text-gray-500 bg-gray-50 p-3 rounded border text-sm italic mb-4">Belum ada materi di bab ini.</p>`;
            } else {
                materialsHtml = `
                    <div class="space-y-2 mb-6">
                        ${chap.materials.map(m => `
                            <div class="flex justify-between items-center p-3 bg-white rounded border border-gray-100 hover:border-red-200 transition-colors shadow-sm">
                                <div>
                                    <span class="text-sm font-bold text-gray-800">${m.title}</span>
                                    <span class="text-[10px] block text-gray-400 uppercase font-semibold">${getMLabel(m.type)}</span>
                                </div>
                                <button onclick="window.delMat('${subId}','${chapId}','${m.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded-full transition-colors" title="Hapus Materi">
                                    üóëÔ∏è
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            workspace.innerHTML = `
                <div class="mb-6 bg-teal-50 p-4 rounded-lg border border-teal-100">
                    <h4 class="font-bold mb-3 text-teal-800 text-sm">‚ûï Tambah Materi Baru ke Bab ini</h4>
                    <div class="space-y-2">
                        <input id="m-title" class="w-full border p-2 rounded text-sm" placeholder="Judul Materi (Contoh: Penjumlahan Pecahan)">
                        <div class="flex gap-2">
                            <select id="m-type" class="flex-grow border p-2 rounded text-sm">
                                <option value="video">Video (YouTube)</option>
                                <option value="document">Dokumen / PDF</option>
                                <option value="quiz">Kuis / Latihan</option>
                            </select>
                            <input id="m-url" class="w-full border p-2 rounded text-sm" placeholder="URL Tautan / ID Youtube">
                        </div>
                        <button onclick="window.addMat()" class="w-full bg-teal-600 text-white p-2 rounded hover:bg-teal-700 font-bold text-sm shadow">Simpan Materi</button>
                    </div>
                </div>
                <hr class="my-4">
                <h4 class="font-bold mb-3 text-gray-700 text-sm">üìã Daftar Materi Tersimpan</h4>
                ${materialsHtml}
            `;
        };

        window.addSub = async () => {
            if (!window.currentUser) return;
            const nameInput = document.getElementById('new-sub-name');
            const iconInput = document.getElementById('new-sub-icon');
            if(!nameInput) return;

            const name = nameInput.value;
            const icon = iconInput ? iconInput.value || 'üìö' : 'üìö';
            if (!name) return;
            try {
                const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', window.generateId());
                await window.setDoc(docRef, { name, icon, chapters: [] });
                nameInput.value = '';
                if(iconInput) iconInput.value = '';
                window.showMod("Berhasil", "Mata Pelajaran berhasil ditambahkan.", "success");
            } catch (e) { console.error(e); }
        };

        window.addChap = async () => {
            if (!window.currentUser) return;
            const subDropdown = document.getElementById('adm-sub');
            const titleInput = document.getElementById('new-chap-name');
            if(!subDropdown || !titleInput) return;

            const subId = subDropdown.value;
            const title = titleInput.value;
            if (!subId || !title) return;
            try {
                const subRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', subId);
                await window.updateDoc(subRef, { chapters: window.arrayUnion({ id: window.generateId(), title, materials: [] }) });
                titleInput.value = '';
                window.showMod("Berhasil", "Bab baru telah ditambahkan.", "success");
            } catch (e) { console.error(e); }
        };

        window.addMat = async () => {
            if (!window.currentUser) return;
            const subDropdown = document.getElementById('adm-sub');
            const chapDropdown = document.getElementById('adm-chap');
            const titleInput = document.getElementById('m-title');
            const urlInput = document.getElementById('m-url');
            const typeDropdown = document.getElementById('m-type');
            
            if(!subDropdown || !chapDropdown || !titleInput || !urlInput || !typeDropdown) return;

            const subId = subDropdown.value;
            const chapId = chapDropdown.value;
            const title = titleInput.value;
            const type = typeDropdown.value;
            const url = urlInput.value;
            
            if (!subId || !chapId || !title || !url) {
                window.showMod("Gagal", "Lengkapi semua data materi.", "error");
                return;
            }
            
            try {
                const subRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', subId);
                const sub = window.appState.subjects.find(s => s.id === subId);
                if (!sub) return;

                const updatedChapters = sub.chapters.map(c => {
                    if (c.id === chapId) {
                        return {
                            ...c,
                            materials: [...(c.materials || []), { id: window.generateId(), title, type, url }]
                        };
                    }
                    return c;
                });

                await window.updateDoc(subRef, { chapters: updatedChapters });
                
                titleInput.value = '';
                urlInput.value = '';
                window.showMod("Berhasil", "Materi telah disimpan.", "success");
            } catch (e) { 
                console.error(e);
                window.showMod("Error", "Gagal menyimpan materi.", "error");
            }
        };

        window.delMat = async (subId, chapId, matId) => {
            if (!window.currentUser) return;
            if (!confirm("Hapus materi ini secara permanen?")) return;
            try {
                const subRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', subId);
                const sub = window.appState.subjects.find(s => s.id === subId);
                const chapters = sub.chapters.map(c => {
                    if (c.id === chapId) {
                        return {
                            ...c,
                            materials: (c.materials || []).filter(m => m.id !== matId)
                        };
                    }
                    return c;
                });
                await window.updateDoc(subRef, { chapters });
            } catch (e) { console.error(e); }
        };

        function renderBantuan(container) {
            container.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4">Pusat Bantuan</h2>
                    <p class="mb-4 text-gray-600">Selamat datang di Rumah Belajar Kelas 5. Platform ini dirancang untuk memudahkan siswa mengakses materi sekolah.</p>
                    <div class="space-y-4">
                        <div class="p-4 bg-teal-50 rounded-lg border border-teal-100">
                            <h4 class="font-bold text-teal-800">Bagaimana cara belajar?</h4>
                            <p class="text-sm">Pilih menu "Pelajaran", pilih mata pelajaran yang ingin dipelajari, pilih Bab, lalu klik materi yang tersedia.</p>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                            <h4 class="font-bold text-blue-800">Butuh bantuan Cikgu Tere?</h4>
                            <p class="text-sm">Klik ikon gelembung pesan di pojok kanan bawah untuk bertanya pada asisten pintar kami.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function getMIcon(t) { return { video: 'üé¨', document: 'üìÑ', quiz: 'üìù' }[t] || 'üìö'; }
        function getMLabel(t) { return { video: 'Video', document: 'Dokumen', quiz: 'Kuis' }[t] || 'Materi'; }
        function getMColor(t) { return { video: 'border-red-500', document: 'border-green-500', quiz: 'border-purple-500' }[t] || 'border-gray-500'; }
        
        function renderContent(m) {
            if (m.type === 'video') {
                let vid = "";
                if (m.url.includes('v=')) vid = m.url.split('v=')[1].split('&')[0];
                else if (m.url.includes('be/')) vid = m.url.split('be/')[1].split('?')[0];
                else vid = m.url.split('/').pop();
                return `<div class="embed-responsive-container"><iframe src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe></div>`;
            }
            return `<div class="text-center py-20 flex flex-col items-center">
                <div class="text-6xl mb-6">${getMIcon(m.type)}</div>
                <p class="mb-6 text-gray-600 font-medium">Materi ini tersedia dalam format ${getMLabel(m.type)}.</p>
                <a href="${m.url}" target="_blank" class="bg-teal-600 text-white px-8 py-3 rounded-full hover:bg-teal-700 font-bold shadow-lg transition-transform hover:scale-105 inline-block">Buka Sekarang</a>
            </div>`;
        }

        window.showMod = (t, m, type) => {
            const mod = document.getElementById('generic-modal');
            const content = document.getElementById('modal-content');
            if(!mod || !content) return;
            
            content.innerHTML = `
                <div class="text-center">
                    <div class="text-4xl mb-2">${type === 'success' ? '‚úÖ' : '‚ùå'}</div>
                    <h3 class="font-bold text-xl mb-2">${t}</h3>
                    <p class="mb-6 text-gray-600">${m}</p>
                    <button onclick="window.closeModal()" class="w-full bg-teal-600 text-white p-3 rounded-lg font-bold hover:bg-teal-700">Tutup</button>
                </div>
            `;
            mod.classList.remove('hidden'); mod.classList.add('flex');
        };
        window.closeModal = () => document.getElementById('generic-modal').classList.add('hidden');

        document.getElementById('chat-toggle').onclick = () => document.getElementById('chat-modal').classList.toggle('hidden');
        document.getElementById('chat-close').onclick = () => document.getElementById('chat-modal').classList.add('hidden');
    </script>
</body>
</html>
