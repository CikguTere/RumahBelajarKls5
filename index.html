<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rumah Belajar Kelas 5 - Sekolah Dasar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        #chat-content::-webkit-scrollbar { width: 8px; }
        #chat-content::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .tab-button.active { border-color: #10b981; color: #10b981; font-weight: 600; }
        .material-iframe { width: 100%; height: 400px; border-radius: 0.5rem; border: 2px solid #e2e8f0; }
        .floating-chat { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .embed-responsive-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 0.5rem; }
        .embed-responsive-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* Loading animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0d9488;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, query, onSnapshot, getDoc, updateDoc, arrayUnion, deleteDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase functions
        window.collection = collection; window.doc = doc; window.setDoc = setDoc; window.query = query;
        window.onSnapshot = onSnapshot; window.getDoc = getDoc; window.updateDoc = updateDoc;
        window.arrayUnion = arrayUnion; window.deleteDoc = deleteDoc; window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const hideLoading = () => {
            const overlay = document.getElementById('loading-overlay');
            const app = document.getElementById('app-container');
            if (overlay) overlay.classList.add('hidden');
            if (app) app.classList.remove('hidden');
        };

        // Safety Timeout: Jika Firebase kelamaan (3 detik), paksa masuk aplikasi
        setTimeout(() => {
            if (!window.currentUser && firebaseConfig.apiKey) {
                console.warn("Firebase took too long. Forcing UI...");
                hideLoading();
                window.renderApp();
            }
        }, 3000);

        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                
                const initAuth = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(window.auth, initialAuthToken);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    } catch (error) {
                        console.error("Auth error:", error);
                        hideLoading(); // Tetap tampilkan UI meski auth gagal
                    }
                };

                onAuthStateChanged(window.auth, (user) => {
                    window.currentUser = user;
                    window.currentUserId = user?.uid;
                    hideLoading();
                    if (user) {
                        window.startDataListeners();
                    }
                    window.renderApp();
                });

                initAuth();
            } catch (err) {
                console.error("Firebase Init Error:", err);
                hideLoading();
            }
        } else {
            // Mode Tanpa Firebase (Preview/Local)
            console.log("Running in offline/preview mode...");
            setTimeout(() => {
                hideLoading();
                window.renderApp();
            }, 500);
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Overlay Loading yang lebih keren -->
    <div id="loading-overlay" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[9999]">
        <div class="loader mb-4"></div>
        <div class="text-xl font-bold text-teal-600 animate-pulse">Menyiapkan Ruang Belajar...</div>
        <p class="text-gray-400 text-sm mt-2">Harap tunggu sebentar ya, Bro.</p>
    </div>

    <div id="app-container" class="hidden">
        <header class="bg-white shadow-lg sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
                <div class="flex flex-col sm:flex-row items-baseline gap-2 cursor-pointer" onclick="window.goBackToSubjects()">
                    <h1 class="text-3xl font-bold text-teal-600 flex items-center">
                        üè† Rumah Belajar Kelas 5
                    </h1>
                    <span class="text-sm text-gray-400 italic">Developed by Cikgu Tere</span>
                </div>
                <nav id="tabs" class="mt-4 sm:mt-0 flex space-x-2 border-b border-gray-200"></nav>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-8">
            <div id="content-container"></div>
        </main>

        <!-- Chat Floating Button -->
        <div class="floating-chat">
            <button id="chat-toggle" class="bg-teal-600 text-white p-4 rounded-full shadow-lg hover:scale-110 transition-transform">
                <span class="text-xl">üí¨</span>
            </button>
        </div>

        <!-- Chat Modal -->
        <div id="chat-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-[1001]">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4 flex flex-col h-[500px]">
                <div class="p-4 bg-teal-600 text-white flex justify-between rounded-t-xl items-center">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">ü§ñ</span>
                        <h3 class="font-bold">Cikgu Tere</h3>
                    </div>
                    <button id="chat-close" class="text-2xl">&times;</button>
                </div>
                <div id="chat-content" class="flex-grow p-4 overflow-y-auto space-y-4 bg-gray-50">
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 self-start max-w-[80%]">
                        <p class="text-sm text-gray-800">Halo! Ada yang bisa Cikgu bantu hari ini?</p>
                    </div>
                </div>
                <div class="p-4 border-t bg-white flex gap-2">
                    <input type="text" id="chat-input" class="flex-grow p-2 border rounded-lg focus:ring-2 focus:ring-teal-500 outline-none" placeholder="Tanya sesuatu...">
                    <button id="chat-send" class="bg-teal-600 text-white px-4 py-2 rounded-lg font-bold">Kirim</button>
                </div>
            </div>
        </div>

        <!-- Pop-up Modal -->
        <div id="generic-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-[2000]">
            <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-sm m-4 p-6 scale-in transition-all"></div>
        </div>
    </div>

    <script>
        window.generateId = () => 'id-' + Math.random().toString(36).substr(2, 9);
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        window.appState = {
            activeTab: 'login',
            isAdmin: false,
            subjects: [],
            attendance: [],
            studentProfile: JSON.parse(localStorage.getItem('student_profile')) || null,
            selectedSubjectId: null,
            selectedChapterId: null,
            selectedMaterialId: null,
        };

        window.startDataListeners = () => {
            if (window.db && !window.listenerActive && window.currentUser) {
                window.listenerActive = true;
                
                // Listen to subjects
                const qSub = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects');
                window.onSnapshot(qSub, (snap) => {
                    window.appState.subjects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    window.renderApp();
                }, (err) => console.error("Snapshot error (subjects):", err));

                // Listen to attendance
                const qAtt = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'attendance');
                window.onSnapshot(qAtt, (snap) => {
                    window.appState.attendance = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (window.appState.activeTab === 'admin' && window.appState.isAdmin) {
                        window.renderApp();
                    }
                }, (err) => console.error("Snapshot error (attendance):", err));
            }
        };

        window.renderApp = () => {
            const tabsContainer = document.getElementById('tabs');
            if (!tabsContainer) return;

            const tabs = [
                { id: 'login', label: 'üëã Masuk' },
                { id: 'mapel', label: 'üìö Pelajaran' },
                { id: 'admin', label: 'üõ°Ô∏è Admin' },
                { id: 'bantuan', label: '‚ùì Bantuan' }
            ];
            
            tabsContainer.innerHTML = tabs.map(t => `
                <button onclick="window.switchTab('${t.id}')" class="px-4 py-2 border-b-2 transition-all ${window.appState.activeTab === t.id ? 'border-teal-600 text-teal-600 font-bold' : 'border-transparent text-gray-500 hover:text-teal-400'}">
                    ${t.label}
                </button>
            `).join('');

            const container = document.getElementById('content-container');
            if (!container) return;

            // Page Switcher
            switch (window.appState.activeTab) {
                case 'login': renderLoginSiswa(container); break;
                case 'mapel': renderMapel(container); break;
                case 'admin': window.appState.isAdmin ? renderAdmin(container) : renderLoginAdmin(container); break;
                default: renderBantuan(container);
            }
        };

        window.switchTab = (tab) => { 
            if (tab === 'mapel' && !window.appState.studentProfile) {
                window.showMod("Perhatian", "Silakan isi data diri/login terlebih dahulu di tab Masuk.", "error");
                window.appState.activeTab = 'login';
            } else {
                window.appState.activeTab = tab; 
            }
            window.renderApp(); 
        };

        window.goBackToSubjects = () => { 
            window.appState.selectedSubjectId = null; 
            window.appState.selectedChapterId = null; 
            window.appState.selectedMaterialId = null; 
            window.renderApp(); 
        };

        function renderLoginSiswa(container) {
            if (window.appState.studentProfile) {
                container.innerHTML = `
                    <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl text-center border border-gray-100">
                        <div class="text-6xl mb-4">‚ú®</div>
                        <h2 class="text-2xl font-bold mb-2">Halo, ${window.appState.studentProfile.nama}!</h2>
                        <p class="text-gray-500 mb-6">Kamu sudah terabsen dari <b>${window.appState.studentProfile.sekolah}</b>.</p>
                        <button onclick="window.switchTab('mapel')" class="w-full bg-teal-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-teal-700 transition-all hover:scale-[1.02]">Mulai Belajar Sekarang</button>
                        <button onclick="localStorage.removeItem('student_profile'); window.appState.studentProfile=null; window.renderApp();" class="mt-6 text-sm text-red-400 hover:text-red-600 hover:underline">Ganti Identitas Siswa</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
                    <h2 class="text-2xl font-bold mb-2 text-gray-800">Presensi Siswa</h2>
                    <p class="text-sm text-gray-500 mb-8">Lengkapi data di bawah sebelum memulai petualangan belajarmu!</p>
                    <div class="space-y-5">
                        <div>
                            <label class="block text-xs font-bold text-teal-600 uppercase mb-2 tracking-wider">Nama Lengkap</label>
                            <input type="text" id="s-nama" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none transition-all" placeholder="Contoh: Budi Santoso">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-teal-600 uppercase mb-2 tracking-wider">Asal Provinsi</label>
                            <input type="text" id="s-prov" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none transition-all" placeholder="Misal: Jawa Tengah">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-teal-600 uppercase mb-2 tracking-wider">Asal Sekolah</label>
                            <input type="text" id="s-sekolah" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none transition-all" placeholder="Nama SD Kamu">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-teal-600 uppercase mb-2 tracking-wider">Kelas</label>
                            <select id="s-kelas" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 outline-none appearance-none bg-white">
                                <option value="5A">Kelas 5A</option>
                                <option value="5B">Kelas 5B</option>
                                <option value="5C">Kelas 5C</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <button onclick="window.submitLoginSiswa()" class="w-full bg-teal-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-teal-700 transition-all hover:scale-[1.02] mt-4">Simpan & Mulai Belajar</button>
                    </div>
                </div>
            `;
        }

        window.submitLoginSiswa = async () => {
            const nama = document.getElementById('s-nama').value;
            const provinsi = document.getElementById('s-prov').value;
            const sekolah = document.getElementById('s-sekolah').value;
            const kelas = document.getElementById('s-kelas').value;

            if (!nama || !provinsi || !sekolah) {
                window.showMod("Oops!", "Lengkapi semua data dulu ya agar Cikgu bisa mengenalmu.", "error");
                return;
            }

            const profile = { nama, provinsi, sekolah, kelas, timestamp: new Date().toISOString() };
            
            if (window.db) {
                try {
                    const attRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'attendance');
                    await window.addDoc(attRef, { ...profile, serverTime: window.serverTimestamp() });
                } catch (e) {
                    console.warn("Firestore error (attendance):", e);
                }
            }
            
            localStorage.setItem('student_profile', JSON.stringify(profile));
            window.appState.studentProfile = profile;
            window.showMod("Berhasil Masuk!", `Selamat belajar, ${nama}!`, "success");
            window.renderApp();
        };

        function renderMapel(container) {
            if (window.appState.selectedMaterialId) return renderMaterialDetail(container);
            if (window.appState.selectedChapterId) return renderChapterDetail(container);
            if (window.appState.selectedSubjectId) return renderSubjectDetail(container);

            container.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-center mb-8">
                    <h2 class="text-3xl font-extrabold text-gray-800">Daftar Pelajaran</h2>
                    <p class="text-gray-400 text-sm italic">Pilih satu untuk mulai membaca materi</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    ${window.appState.subjects.length === 0 ? '<div class="col-span-full text-center py-10 bg-white rounded-xl text-gray-400">Belum ada mata pelajaran yang ditambahkan oleh Admin.</div>' : ''}
                    ${window.appState.subjects.map(s => `
                        <div onclick="window.appState.selectedSubjectId='${s.id}'; window.renderApp()" class="bg-white p-8 rounded-2xl shadow-sm hover:shadow-xl cursor-pointer border-t-8 border-teal-500 transition-all group relative overflow-hidden">
                            <div class="text-5xl mb-4 group-hover:scale-110 transition-transform duration-300">${s.icon || 'üìö'}</div>
                            <div class="font-bold text-xl text-gray-800">${s.name}</div>
                            <div class="text-xs text-gray-400 mt-3 font-semibold uppercase tracking-widest">
                                ${s.chapters ? s.chapters.length : 0} Bab Tersedia
                            </div>
                            <div class="absolute -right-4 -bottom-4 opacity-5 text-8xl group-hover:rotate-12 transition-transform">${s.icon || 'üìö'}</div>
                        </div>
                    `).join('')}
                </div>`;
        }

        function renderSubjectDetail(container) {
            const subject = window.appState.subjects.find(s => s.id === window.appState.selectedSubjectId);
            if (!subject) return window.goBackToSubjects();

            container.innerHTML = `
                <button onclick="window.goBackToSubjects()" class="mb-6 text-teal-600 font-bold flex items-center hover:translate-x-[-5px] transition-transform">
                    <span class="mr-2">‚Üê</span> Kembali ke Menu Utama
                </button>
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 mb-8">
                    <h2 class="text-3xl font-black text-gray-800 mb-2">${subject.icon} ${subject.name}</h2>
                    <p class="text-gray-500">Pilih Bab materi yang ingin kamu kuasai hari ini.</p>
                </div>
                <div class="grid gap-4">
                    ${(!subject.chapters || subject.chapters.length === 0) ? '<p class="text-gray-500 italic p-10 text-center bg-gray-50 rounded-xl border-2 border-dashed">Belum ada bab untuk mata pelajaran ini.</p>' : ''}
                    ${(subject.chapters || []).map((c, idx) => `
                        <div onclick="window.appState.selectedChapterId='${c.id}'; window.renderApp()" class="bg-white p-6 rounded-xl shadow-sm cursor-pointer hover:bg-teal-50 border border-gray-100 flex justify-between items-center group transition-all">
                            <div class="flex items-center">
                                <span class="bg-teal-100 text-teal-600 font-bold w-10 h-10 rounded-lg flex items-center justify-center mr-4 group-hover:bg-teal-600 group-hover:text-white transition-colors">
                                    ${idx + 1}
                                </span>
                                <span class="font-bold text-gray-700 text-lg">${c.title}</span>
                            </div>
                            <div class="text-xs font-bold text-gray-300 group-hover:text-teal-500 transition-colors uppercase tracking-widest">
                                ${c.materials ? c.materials.length : 0} Konten Materi ‚Üí
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        }

        function renderChapterDetail(container) {
            const subject = window.appState.subjects.find(s => s.id === window.appState.selectedSubjectId);
            const chapter = subject?.chapters?.find(c => c.id === window.appState.selectedChapterId);
            if (!chapter) { window.appState.selectedChapterId = null; return window.renderApp(); }

            container.innerHTML = `
                <button onclick="window.appState.selectedChapterId=null; window.renderApp()" class="mb-6 text-teal-600 font-bold flex items-center hover:translate-x-[-5px] transition-transform">
                    <span class="mr-2">‚Üê</span> Daftar Bab
                </button>
                <h2 class="text-3xl font-black text-gray-800 mb-8">${chapter.title}</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${(!chapter.materials || chapter.materials.length === 0) ? '<p class="col-span-full text-center text-gray-400">Belum ada materi di bab ini.</p>' : ''}
                    ${(chapter.materials || []).map(m => `
                        <div onclick="window.appState.selectedMaterialId='${m.id}'; window.renderApp()" class="bg-white p-6 rounded-2xl shadow-sm flex items-center cursor-pointer hover:shadow-md border-l-8 ${getMColor(m.type)} transition-all hover:scale-[1.01]">
                            <span class="mr-6 text-4xl">${getMIcon(m.type)}</span>
                            <div>
                                <div class="font-black text-gray-800 text-lg leading-tight mb-1">${m.title}</div>
                                <div class="text-[10px] text-gray-400 uppercase tracking-[0.2em] font-black">${getMLabel(m.type)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        }

        function renderMaterialDetail(container) {
            const subject = window.appState.subjects.find(s => s.id === window.appState.selectedSubjectId);
            const chapter = subject?.chapters?.find(c => c.id === window.appState.selectedChapterId);
            const material = chapter?.materials?.find(m => m.id === window.appState.selectedMaterialId);
            if (!material) { window.appState.selectedMaterialId = null; return window.renderApp(); }
            
            container.innerHTML = `
                <button onclick="window.appState.selectedMaterialId=null; window.renderApp()" class="mb-6 text-teal-600 font-bold flex items-center hover:translate-x-[-5px] transition-transform">
                    <span class="mr-2">‚Üê</span> Kembali ke Daftar Materi
                </button>
                <div class="bg-white p-8 rounded-3xl shadow-lg border border-gray-50">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="text-3xl">${getMIcon(material.type)}</span>
                        <h2 class="text-3xl font-black text-gray-800">${material.title}</h2>
                    </div>
                    <div class="rounded-2xl overflow-hidden border-2 border-gray-50 bg-gray-50">
                        ${renderContent(material)}
                    </div>
                </div>`;
        }

        // Admin Logics (Sesuai kode sebelumnya tapi dipercantik)
        function renderLoginAdmin(container) {
            container.innerHTML = `
                <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-2xl border border-gray-100">
                    <div class="text-center mb-8">
                        <div class="text-5xl mb-2">üîê</div>
                        <h2 class="text-2xl font-black text-gray-800 uppercase tracking-tighter">Panel Pengelola</h2>
                        <p class="text-xs text-gray-400">Area ini khusus untuk Admin dan Guru</p>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Password Akses</label>
                            <input type="password" id="pw" class="w-full p-4 border rounded-xl focus:ring-2 focus:ring-teal-500 outline-none transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <button onclick="if(document.getElementById('pw').value==='admin123'){window.appState.isAdmin=true; window.renderApp();}else{window.showMod('Gagal', 'Kata sandi salah.', 'error');}" class="w-full bg-gray-800 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-black transition-all">Buka Kunci Panel</button>
                    </div>
                </div>`;
        }

        function renderAdmin(container) {
            container.innerHTML = `
                <div class="flex justify-between items-end mb-8">
                    <h2 class="text-4xl font-black text-gray-800">Panel Admin</h2>
                    <button onclick="window.appState.isAdmin=false; window.renderApp()" class="text-xs text-red-500 hover:underline">Keluar Admin</button>
                </div>

                <div class="mb-10 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-black text-xl text-teal-800">üë• Rekap Kehadiran Siswa</h3>
                        <div class="px-3 py-1 bg-teal-100 text-teal-700 rounded-full text-xs font-bold">${window.appState.attendance.length} Siswa Masuk</div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-gray-400 text-[10px] font-black uppercase tracking-widest">
                                <tr>
                                    <th class="p-4 rounded-l-lg">Waktu</th>
                                    <th class="p-4">Nama Siswa</th>
                                    <th class="p-4">Sekolah & Kelas</th>
                                    <th class="p-4">Provinsi</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${window.appState.attendance.length === 0 ? '<tr><td colspan="4" class="p-10 text-center text-gray-300 italic">Belum ada data masuk hari ini.</td></tr>' : ''}
                                ${window.appState.attendance.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(att => `
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="p-4 text-sm text-gray-400 font-mono">${new Date(att.timestamp).toLocaleTimeString()}</td>
                                        <td class="p-4 font-bold text-gray-800">${att.nama}</td>
                                        <td class="p-4">
                                            <div class="text-sm text-gray-600">${att.sekolah}</div>
                                            <div class="text-[10px] font-black text-teal-600 uppercase">${att.kelas}</div>
                                        </td>
                                        <td class="p-4 text-sm text-gray-500">${att.provinsi}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-black text-xl mb-6 flex items-center"><span class="mr-3 p-2 bg-blue-100 rounded-lg text-lg">üìÇ</span> Struktur Mapel</h3>
                        <label class="block text-xs font-black text-gray-400 uppercase mb-2">Pilih Mata Pelajaran</label>
                        <select id="adm-sub" class="w-full p-4 border border-gray-200 rounded-xl mb-6 bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500" onchange="window.handleSubChange()">
                            <option value="">-- Pilih Mapel --</option>
                            ${window.appState.subjects.map(s => `<option value="${s.id}" ${window.lastSelectedSubId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
                        </select>
                        <div id="adm-chapter-selection-area"></div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-black text-xl mb-6 flex items-center"><span class="mr-3 p-2 bg-teal-100 rounded-lg text-lg">‚öôÔ∏è</span> Editor Materi</h3>
                        <div id="materi-workspace">
                            <p class="text-center py-20 text-gray-300 italic">Pilih mapel dan bab di kiri untuk mengedit materi.</p>
                        </div>
                    </div>
                </div>

                <div class="mt-8 bg-gray-800 p-8 rounded-3xl text-white shadow-xl">
                    <h3 class="font-black text-xl mb-6 flex items-center">‚≠ê Master: Tambah Mata Pelajaran Baru</h3>
                    <div class="flex flex-col md:flex-row gap-4">
                        <input id="new-sub-name" class="bg-gray-700 border-none p-4 flex-grow rounded-xl text-white placeholder-gray-500 outline-none focus:ring-2 focus:ring-teal-500" placeholder="Nama Mapel (Contoh: IPA)">
                        <input id="new-sub-icon" class="bg-gray-700 border-none p-4 w-full md:w-32 rounded-xl text-center text-white outline-none focus:ring-2 focus:ring-teal-500" placeholder="Icon (üß™)">
                        <button onclick="window.addSub()" class="bg-teal-500 hover:bg-teal-400 text-white px-8 py-4 rounded-xl font-black transition-all shadow-lg active:scale-95">Simpan Mapel</button>
                    </div>
                </div>
            `;
            const subDropdown = document.getElementById('adm-sub');
            if (subDropdown && subDropdown.value) window.handleSubChange(true);
        }

        // Logic Helper tetap sama dengan versi sebelumnya
        window.handleSubChange = () => {
            const subId = document.getElementById('adm-sub').value;
            window.lastSelectedSubId = subId;
            const area = document.getElementById('adm-chapter-selection-area');
            if (!subId) { area.innerHTML = ''; return; }

            const sub = window.appState.subjects.find(s => s.id === subId);
            area.innerHTML = `
                <label class="block text-xs font-black text-gray-400 uppercase mb-2">Pilih Bab</label>
                <select id="adm-chap" class="w-full p-4 border border-gray-200 rounded-xl mb-6 bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500" onchange="window.updateAdminManageList()">
                    <option value="">-- Pilih Bab --</option>
                    ${(sub.chapters || []).map(c => `<option value="${c.id}" ${window.lastSelectedChapId === c.id ? 'selected' : ''}>${c.title}</option>`).join('')}
                </select>
                <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                    <h4 class="text-sm font-black text-blue-800 uppercase mb-4 tracking-tighter">‚ûï Tambah Bab Baru</h4>
                    <div class="flex gap-2">
                        <input id="new-chap-name" class="flex-grow p-3 border rounded-xl outline-none text-sm" placeholder="Nama Bab">
                        <button onclick="window.addChap()" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold hover:bg-blue-700 transition-colors">Simpan</button>
                    </div>
                </div>
            `;
            if(window.lastSelectedChapId) window.updateAdminManageList();
        };

        window.updateAdminManageList = () => {
            const subId = document.getElementById('adm-sub').value;
            const chapId = document.getElementById('adm-chap').value;
            window.lastSelectedChapId = chapId;
            const ws = document.getElementById('materi-workspace');
            if (!subId || !chapId) return;

            const sub = window.appState.subjects.find(s => s.id === subId);
            const chap = sub?.chapters?.find(c => c.id === chapId);

            ws.innerHTML = `
                <div class="bg-teal-50 p-6 rounded-2xl mb-8 border border-teal-100">
                    <h4 class="text-sm font-black text-teal-800 uppercase mb-4 tracking-tighter">‚ûï Input Materi</h4>
                    <div class="space-y-3">
                        <input id="m-title" class="w-full p-3 border rounded-xl text-sm" placeholder="Judul Materi">
                        <div class="grid grid-cols-2 gap-2">
                            <select id="m-type" class="p-3 border rounded-xl text-sm bg-white">
                                <option value="video">Video</option>
                                <option value="document">Dokumen</option>
                                <option value="quiz">Kuis</option>
                            </select>
                            <input id="m-url" class="p-3 border rounded-xl text-sm" placeholder="Link/ID YouTube">
                        </div>
                        <button onclick="window.addMat()" class="w-full bg-teal-600 text-white p-3 rounded-xl font-bold hover:bg-teal-700 shadow-md">Simpan Konten</button>
                    </div>
                </div>
                <h4 class="text-xs font-black text-gray-400 uppercase mb-4 tracking-widest">üìã Konten Bab Ini</h4>
                <div class="space-y-2">
                    ${(!chap || !chap.materials || chap.materials.length === 0) ? '<p class="text-center py-4 text-gray-300 text-sm">Belum ada konten.</p>' : ''}
                    ${(chap?.materials || []).map(m => `
                        <div class="flex justify-between items-center p-3 bg-white border border-gray-100 rounded-xl hover:border-red-200 transition-all">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${getMIcon(m.type)}</span>
                                <span class="text-sm font-bold text-gray-700">${m.title}</span>
                            </div>
                            <button onclick="window.delMat('${subId}','${chapId}','${m.id}')" class="text-red-400 hover:text-red-600 p-2">üóëÔ∏è</button>
                        </div>
                    `).join('')}
                </div>
            `;
        };

        // Standard CRUD (No change, just keep functionality)
        window.addSub = async () => {
            const name = document.getElementById('new-sub-name').value;
            const icon = document.getElementById('new-sub-icon').value || 'üìö';
            if (!name) return;
            if (window.db) {
                const id = window.generateId();
                await window.setDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', id), { name, icon, chapters: [] });
            }
            document.getElementById('new-sub-name').value = '';
            window.showMod("Berhasil", "Mata Pelajaran ditambahkan!", "success");
        };

        window.addChap = async () => {
            const subId = document.getElementById('adm-sub').value;
            const title = document.getElementById('new-chap-name').value;
            if (!subId || !title) return;
            if (window.db) {
                const subRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', subId);
                await window.updateDoc(subRef, { chapters: window.arrayUnion({ id: window.generateId(), title, materials: [] }) });
            }
            document.getElementById('new-chap-name').value = '';
            window.showMod("Sip!", "Bab baru sudah siap.", "success");
        };

        window.addMat = async () => {
            const subId = document.getElementById('adm-sub').value;
            const chapId = document.getElementById('adm-chap').value;
            const title = document.getElementById('m-title').value;
            const type = document.getElementById('m-type').value;
            const url = document.getElementById('m-url').value;
            if (!subId || !chapId || !title || !url) return;

            if (window.db) {
                const subRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', subId);
                const sub = window.appState.subjects.find(s => s.id === subId);
                const updatedChapters = sub.chapters.map(c => {
                    if (c.id === chapId) return { ...c, materials: [...(c.materials || []), { id: window.generateId(), title, type, url }] };
                    return c;
                });
                await window.updateDoc(subRef, { chapters: updatedChapters });
            }
            document.getElementById('m-title').value = '';
            document.getElementById('m-url').value = '';
            window.showMod("Oke!", "Materi berhasil diunggah.", "success");
        };

        window.delMat = async (subId, chapId, matId) => {
            if (!confirm("Hapus materi ini?")) return;
            if (window.db) {
                const subRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', subId);
                const sub = window.appState.subjects.find(s => s.id === subId);
                const chapters = sub.chapters.map(c => {
                    if (c.id === chapId) return { ...c, materials: (c.materials || []).filter(m => m.id !== matId) };
                    return c;
                });
                await window.updateDoc(subRef, { chapters });
            }
        };

        function getMIcon(t) { return { video: 'üé¨', document: 'üìÑ', quiz: 'üìù' }[t] || 'üìö'; }
        function getMLabel(t) { return { video: 'Video', document: 'Dokumen', quiz: 'Kuis' }[t] || 'Materi'; }
        function getMColor(t) { return { video: 'border-red-400', document: 'border-emerald-400', quiz: 'border-purple-400' }[t] || 'border-gray-200'; }
        
        function renderContent(m) {
            if (m.type === 'video') {
                let vid = "";
                if (m.url.includes('v=')) vid = m.url.split('v=')[1].split('&')[0];
                else if (m.url.includes('be/')) vid = m.url.split('be/')[1].split('?')[0];
                else vid = m.url.split('/').pop();
                return `<div class="embed-responsive-container"><iframe src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe></div>`;
            }
            return `<div class="text-center py-24 flex flex-col items-center">
                <div class="text-7xl mb-6 bounce">${getMIcon(m.type)}</div>
                <p class="mb-8 text-gray-500 font-medium">Klik tombol di bawah untuk membuka ${getMLabel(m.type)}.</p>
                <a href="${m.url}" target="_blank" class="bg-teal-600 text-white px-10 py-4 rounded-full hover:bg-teal-700 font-black shadow-xl transition-all hover:scale-105 inline-block">Buka Materi Sekarang</a>
            </div>`;
        }

        function renderBantuan(container) {
            container.innerHTML = `
                <div class="bg-white p-10 rounded-3xl shadow-sm border border-gray-100 max-w-2xl mx-auto">
                    <h2 class="text-3xl font-black text-gray-800 mb-6">Pusat Bantuan</h2>
                    <div class="space-y-6">
                        <div class="flex gap-4 p-4 hover:bg-gray-50 rounded-2xl transition-colors">
                            <span class="text-2xl">üí°</span>
                            <div>
                                <h4 class="font-bold text-gray-800">Cara Belajar</h4>
                                <p class="text-sm text-gray-500">Pilih tab Pelajaran, lalu klik kartu mata pelajaran. Di dalamnya kamu bisa memilih bab dan materi video atau dokumen.</p>
                            </div>
                        </div>
                        <div class="flex gap-4 p-4 hover:bg-gray-50 rounded-2xl transition-colors">
                            <span class="text-2xl">ü§ñ</span>
                            <div>
                                <h4 class="font-bold text-gray-800">Tanya Cikgu Tere</h4>
                                <p class="text-sm text-gray-500">Klik tombol balon chat di pojok kanan bawah. Kamu bisa bertanya apa saja seputar pelajaran!</p>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        window.showMod = (t, m, type) => {
            const mod = document.getElementById('generic-modal');
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-4">${type === 'success' ? '‚úÖ' : '‚ùå'}</div>
                    <h3 class="font-black text-2xl mb-2">${t}</h3>
                    <p class="mb-8 text-gray-500">${m}</p>
                    <button onclick="window.closeModal()" class="w-full bg-teal-600 text-white p-4 rounded-xl font-black hover:bg-teal-700 transition-all active:scale-95 shadow-lg">Siap!</button>
                </div>`;
            mod.classList.remove('hidden'); mod.classList.add('flex');
        };
        window.closeModal = () => document.getElementById('generic-modal').classList.add('hidden');

        document.getElementById('chat-toggle').onclick = () => document.getElementById('chat-modal').classList.toggle('hidden');
        document.getElementById('chat-close').onclick = () => document.getElementById('chat-modal').classList.add('hidden');
    </script>
</body>
</html>
