<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rumah Belajar Kelas 5 - Cikgu Tere</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --accent: #10b981;
            --accent-soft: #ecfdf5;
            --bg-main: #fcfdfe;
            --border-solid: #cbd5e1;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%);
            color: #0f172a;
            font-size: 18px; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 2px solid var(--border-solid);
        }

        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
        }

        .input-elegant {
            background: #ffffff;
            border: 2px solid var(--border-solid);
            transition: all 0.2s ease-in-out;
            font-size: 1.1rem;
        }

        .input-elegant::placeholder {
            color: #94a3b8;
            font-weight: 500;
        }

        .input-elegant:focus {
            background: white;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px -5px rgba(15, 23, 42, 0.25);
        }

        .loader {
            border: 4px solid #f1f5f9;
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #app-container.visible { display: block !important; }

        .tab-active {
            background: white;
            color: var(--accent);
            border: 2px solid var(--accent);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 1.5rem;
            border: 2px solid var(--border-solid);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background-color: #f8fafc;
            color: #64748b;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            padding: 1.25rem 1.5rem;
            text-align: left;
            border-bottom: 2px solid var(--border-solid);
        }

        td {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #f1f5f9;
            background-color: white;
            font-size: 0.95rem;
            color: #1e293b;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, query, onSnapshot, getDoc, updateDoc, arrayUnion, deleteDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.collection = collection; window.doc = doc; window.setDoc = setDoc; window.query = query;
        window.onSnapshot = onSnapshot; window.getDoc = getDoc; window.updateDoc = updateDoc;
        window.arrayUnion = arrayUnion; window.deleteDoc = deleteDoc; window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.hideLoading = () => {
            const overlay = document.getElementById('loading-overlay');
            const app = document.getElementById('app-container');
            if (overlay) overlay.style.opacity = '0';
            setTimeout(() => {
                if (overlay) overlay.style.display = 'none';
                if (app) app.classList.add('visible');
                window.renderApp();
            }, 500);
        };

        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                onAuthStateChanged(window.auth, (user) => {
                    window.currentUser = user;
                    if (user) {
                        window.startDataListeners();
                    }
                    window.hideLoading();
                });
                const initAuth = async () => {
                    if (initialAuthToken) await signInWithCustomToken(window.auth, initialAuthToken);
                    else await signInAnonymously(window.auth);
                };
                initAuth().catch(() => window.hideLoading());
            } catch (err) { window.hideLoading(); }
        } else { setTimeout(window.hideLoading, 800); }
    </script>
</head>
<body class="antialiased">
    <div id="loading-overlay" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[9999] transition-opacity duration-500">
        <div class="loader mb-4"></div>
        <h1 class="text-2xl font-black text-slate-900 tracking-tight">Menyiapkan Ruang Belajar...</h1>
    </div>

    <div id="app-container" class="hidden flex-grow">
        <header class="sticky top-0 z-50 px-4 md:px-6 py-4">
            <div class="max-w-7xl mx-auto flex flex-col lg:flex-row justify-between items-center gap-6 glass p-5 rounded-[2.5rem] card-shadow">
                <div class="flex items-center gap-5 cursor-pointer group" onclick="window.goBackToSubjects()">
                    <div class="w-14 h-14 bg-emerald-500 rounded-[1.25rem] flex items-center justify-center text-3xl shadow-lg shadow-emerald-200 group-hover:rotate-6 transition-transform">üè†</div>
                    <div class="overflow-hidden">
                        <h1 class="text-2xl md:text-3xl font-black text-slate-900 tracking-tighter leading-none whitespace-nowrap">Rumah Belajar Kelas 5</h1>
                        <p class="text-[11px] font-extrabold text-emerald-600 uppercase tracking-[0.25em] mt-1.5">Platform Belajar Cikgu Tere</p>
                    </div>
                </div>
                
                <nav id="tabs" class="flex p-2 bg-slate-100 rounded-[1.5rem] w-full lg:w-auto overflow-x-auto border-2 border-slate-200"></nav>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-6 py-8 md:py-12">
            <div id="content-container"></div>
        </main>
    </div>

    <footer class="py-10 text-center">
        <div class="max-w-7xl mx-auto px-6">
            <div class="h-[2px] w-24 bg-slate-300 mx-auto mb-6"></div>
            <p class="text-slate-500 font-medium text-sm tracking-wide">
                &copy; 2025 Ruang Digital Kelas 5 ‚Ä¢ <span class="text-slate-900 font-bold">Developed by Cikgu Tere</span>
            </p>
        </div>
    </footer>

    <script>
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        window.appState = {
            activeTab: 'login',
            subjects: [],
            attendance: [],
            studentProfile: JSON.parse(localStorage.getItem('student_profile')) || null,
            isAdminLoggedIn: sessionStorage.getItem('admin_session') === 'active',
            viewingSubject: null
        };

        // Listener Terpusat untuk Real-time Data
        window.startDataListeners = () => {
            if (window.db && !window.listenerActive) {
                window.listenerActive = true;
                
                // 1. Listener Pelajaran
                const qSub = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects');
                window.onSnapshot(qSub, (snap) => {
                    window.appState.subjects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    window.renderApp();
                }, (err) => console.error("Subject Listener Error:", err));

                // 2. Listener Absensi (Global)
                const qAtt = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'attendance');
                window.onSnapshot(qAtt, (snap) => {
                    window.appState.attendance = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sortir berdasarkan waktu terbaru
                    window.appState.attendance.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    // Jika sedang di tab admin, render ulang tabelnya saja
                    if (window.appState.activeTab === 'admin' && window.appState.isAdminLoggedIn) {
                        window.updateAttendanceUI();
                    }
                }, (err) => console.error("Attendance Listener Error:", err));
            }
        };

        window.renderApp = () => {
            const tabsContainer = document.getElementById('tabs');
            const container = document.getElementById('content-container');
            if (!tabsContainer || !container) return;

            const tabs = [
                { id: 'login', label: 'Masuk' },
                { id: 'mapel', label: 'Pelajaran' },
                { id: 'admin', label: 'Dashboard' }
            ];
            
            tabsContainer.innerHTML = tabs.map(t => `
                <button onclick="window.switchTab('${t.id}')" class="flex-1 lg:flex-none whitespace-nowrap px-8 py-3 rounded-2xl text-[13px] font-black tracking-widest uppercase transition-all ${window.appState.activeTab === t.id ? 'tab-active' : 'text-slate-400 hover:text-slate-600'}">
                    ${t.label}
                </button>
            `).join('');

            if (window.appState.activeTab === 'login') renderLogin(container);
            else if (window.appState.activeTab === 'mapel') renderMapel(container);
            else if (window.appState.activeTab === 'admin') renderAdmin(container);
        };

        window.switchTab = (tab) => { 
            if (tab === 'mapel' && !window.appState.studentProfile) {
                window.showNotify("Eits! Isi data diri dulu ya.");
                window.appState.activeTab = 'login';
            } else {
                window.appState.activeTab = tab; 
                window.appState.viewingSubject = null;
            }
            window.renderApp(); 
        };

        window.showNotify = (msg) => {
            const div = document.createElement('div');
            div.className = "fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-10 py-5 rounded-[2rem] font-black shadow-2xl z-[9999] animate-bounce text-lg border-2 border-slate-700";
            div.innerText = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        };

        window.goBackToSubjects = () => { 
            window.appState.viewingSubject = null;
            window.switchTab('mapel'); 
        };

        function renderLogin(container) {
            if (window.appState.studentProfile) {
                container.innerHTML = `
                <div class="max-w-2xl mx-auto glass p-12 md:p-16 rounded-[4rem] card-shadow text-center">
                    <div class="w-36 h-36 bg-emerald-100 rounded-[3rem] border-4 border-white flex items-center justify-center text-7xl mx-auto mb-10 animate-pulse shadow-sm">üåü</div>
                    <h2 class="text-4xl md:text-5xl font-black text-slate-900 leading-tight tracking-tighter">Halo,<br><span class="text-emerald-600">${window.appState.studentProfile.nama}</span>!</h2>
                    <p class="text-slate-500 mt-8 mb-14 text-xl font-medium leading-relaxed">Siap untuk petualangan baru di <span class="font-black text-slate-800">${window.appState.studentProfile.sekolah}</span>?</p>
                    <div class="flex flex-col gap-5">
                        <button onclick="window.switchTab('mapel')" class="btn-primary text-white p-7 rounded-[2.5rem] font-black text-xl uppercase tracking-widest">Ayo Mulai Belajar!</button>
                        <button onclick="localStorage.removeItem('student_profile'); window.appState.studentProfile=null; window.renderApp();" class="text-slate-400 hover:text-red-500 font-bold text-sm uppercase tracking-widest mt-6">Bukan kamu? Reset Data</button>
                    </div>
                </div>`;
            } else {
                container.innerHTML = `
                <div class="max-w-xl mx-auto glass p-12 md:p-16 rounded-[4rem] card-shadow">
                    <div class="text-center mb-12">
                        <h2 class="text-4xl font-black text-slate-900 tracking-tighter">Presensi Digital</h2>
                        <div class="h-2 w-20 bg-emerald-500 mx-auto mt-5 rounded-full"></div>
                    </div>
                    <div class="space-y-10">
                        <div class="space-y-8">
                            <div class="space-y-3">
                                <label class="text-[12px] font-black text-slate-500 uppercase tracking-[0.2em] ml-2">Nama Lengkap</label>
                                <input id="s-nama" class="input-elegant w-full p-6 rounded-3xl font-bold text-slate-800" placeholder="Ketik namamu di sini...">
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-3">
                                    <label class="text-[12px] font-black text-slate-500 uppercase tracking-[0.2em] ml-2">Provinsi</label>
                                    <input id="s-prov" class="input-elegant w-full p-6 rounded-3xl font-bold text-slate-800" placeholder="Misal: Jawa Barat">
                                </div>
                                <div class="space-y-3">
                                    <label class="text-[12px] font-black text-slate-500 uppercase tracking-[0.2em] ml-2">Kelas</label>
                                    <select id="s-kelas" class="input-elegant w-full p-6 rounded-3xl font-bold appearance-none cursor-pointer text-slate-800">
                                        <option value="5A">Kelas 5A</option>
                                        <option value="5B">Kelas 5B</option>
                                        <option value="5C">Kelas 5C</option>
                                    </select>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <label class="text-[12px] font-black text-slate-500 uppercase tracking-[0.2em] ml-2">Asal Sekolah</label>
                                <input id="s-sekolah" class="input-elegant w-full p-6 rounded-3xl font-bold text-slate-800" placeholder="Contoh: SDN 01 Merdeka">
                            </div>
                        </div>
                        <button onclick="window.saveProfile()" class="w-full btn-primary text-white p-7 rounded-[2.5rem] font-black text-xl uppercase tracking-widest shadow-2xl">Masuk & Belajar</button>
                    </div>
                </div>`;
            }
        }

        window.saveProfile = async () => {
            const nama = document.getElementById('s-nama').value;
            const provinsi = document.getElementById('s-prov').value;
            const sekolah = document.getElementById('s-sekolah').value;
            const kelas = document.getElementById('s-kelas').value;
            
            if (!nama || !sekolah || !provinsi) {
                window.showNotify("Harap isi semua data ya!"); return;
            }

            const profile = { nama, provinsi, sekolah, kelas, timestamp: new Date().toISOString() };
            if (window.db) {
                try {
                    await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'attendance'), { 
                        ...profile, serverTime: window.serverTimestamp() 
                    });
                } catch(e) { console.error(e); }
            }
            localStorage.setItem('student_profile', JSON.stringify(profile));
            window.appState.studentProfile = profile;
            window.renderApp();
        };

        function renderMapel(container) {
            if (window.appState.viewingSubject) {
                const s = window.appState.viewingSubject;
                container.innerHTML = `
                <div class="mb-14 flex items-center gap-8">
                    <button onclick="window.goBackToSubjects()" class="w-16 h-16 glass flex items-center justify-center rounded-[1.5rem] hover:bg-white text-slate-800 transition-all shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <div>
                        <h2 class="text-4xl md:text-5xl font-black text-slate-900 tracking-tighter leading-none">${s.name}</h2>
                        <p class="text-emerald-600 font-extrabold text-[12px] uppercase tracking-[0.4em] mt-3">Kurikulum Merdeka ‚Ä¢ Kelas 5</p>
                    </div>
                </div>
                
                <div class="space-y-12">
                    ${(s.chapters || []).map((ch, idx) => `
                        <div class="glass p-10 md:p-14 rounded-[3.5rem] card-shadow">
                            <div class="flex items-start justify-between mb-10 border-b-2 border-slate-100 pb-8">
                                <h3 class="font-black text-3xl text-slate-900 pr-10 tracking-tight leading-snug">
                                    <span class="text-emerald-500 bg-emerald-50 border border-emerald-100 px-4 py-1 rounded-xl text-lg mr-2 uppercase tracking-widest">BAB ${idx+1}</span><br>${ch.title}
                                </h3>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                ${(ch.topics || []).map(t => `
                                    <a href="${t.link || '#'}" target="_blank" class="flex items-center gap-6 p-7 bg-white border-2 border-slate-200 hover:border-emerald-500 hover:shadow-lg rounded-[2.5rem] transition-all group">
                                        <div class="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center text-3xl shadow-sm group-hover:bg-emerald-50 group-hover:text-emerald-600 transition-all">üìñ</div>
                                        <div class="flex-grow">
                                            <div class="font-black text-xl text-slate-800 group-hover:text-emerald-600 transition-colors">${t.title}</div>
                                            <div class="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mt-2">Buka Materi ‚Üí</div>
                                        </div>
                                    </a>
                                `).join('')}
                                ${(!ch.topics || ch.topics.length === 0) ? '<p class="text-lg text-slate-400 font-bold italic p-6">Materi belum diunggah.</p>' : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>`;
                return;
            }

            container.innerHTML = `
                <div class="mb-16 text-center">
                    <h2 class="text-5xl md:text-7xl font-black text-slate-900 tracking-tighter">Pilih Materi</h2>
                    <p class="text-slate-500 text-xl font-medium mt-5">Silakan pilih mata pelajaran untuk dipelajari.</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10">
                    ${window.appState.subjects.map(s => `
                        <div onclick="window.openSubject('${s.id}')" class="group glass p-12 rounded-[4rem] card-shadow hover:translate-y-[-10px] transition-all cursor-pointer text-center">
                            <div class="text-8xl mb-10 transform group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 inline-block">${s.icon || 'üìö'}</div>
                            <h3 class="font-black text-3xl text-slate-900 tracking-tight leading-tight">${s.name}</h3>
                            <div class="mt-10 flex items-center justify-center gap-3 text-[12px] font-black text-emerald-600 uppercase tracking-[0.3em] opacity-0 group-hover:opacity-100 transition-all">
                                Masuk Kelas
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        }

        window.openSubject = (id) => {
            const subject = window.appState.subjects.find(s => s.id === id);
            window.appState.viewingSubject = subject;
            window.renderApp();
        };

        function renderAdmin(container) {
            if (!window.appState.isAdminLoggedIn) {
                container.innerHTML = `
                <div class="max-w-xl mx-auto glass p-16 rounded-[4rem] card-shadow text-center">
                    <div class="w-24 h-24 bg-slate-900 text-white border-4 border-white rounded-[2rem] flex items-center justify-center mx-auto mb-10 text-4xl shadow-xl">üîë</div>
                    <h2 class="text-4xl font-black text-slate-900 mb-3 tracking-tighter">Dashboard Guru</h2>
                    <p class="text-[12px] font-black text-slate-400 uppercase tracking-[0.4em] mb-12">Autentikasi Cikgu Tere</p>
                    <div class="space-y-8">
                        <input id="admin-pw" type="password" class="input-elegant w-full p-7 rounded-[2rem] text-center font-black text-3xl" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <button onclick="window.checkAdmin()" class="w-full btn-primary text-white p-7 rounded-[2.5rem] font-black text-xl uppercase tracking-widest shadow-xl">Buka Panel Kontrol</button>
                    </div>
                </div>`;
                return;
            }

            container.innerHTML = `
            <div class="space-y-12">
                <div class="glass p-12 rounded-[3.5rem] card-shadow">
                    <div class="flex justify-between items-center mb-12">
                        <h2 class="font-black text-4xl text-slate-900 tracking-tighter">Panel Guru</h2>
                        <button onclick="window.adminLogout()" class="text-[12px] font-black text-red-500 border-2 border-red-200 px-6 py-3 rounded-2xl hover:bg-red-50 tracking-widest uppercase transition-colors">Keluar</button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
                        <div class="lg:col-span-12">
                            <div class="bg-indigo-50 p-8 rounded-[2.5rem] mb-12 border-2 border-indigo-200">
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                                    <input id="new-sub-icon" class="md:col-span-2 p-6 rounded-3xl text-center text-4xl font-bold border-2 border-indigo-200 bg-white" value="üìö">
                                    <input id="new-sub-name" class="md:col-span-7 p-6 rounded-3xl font-black text-xl border-2 border-indigo-200 bg-white" placeholder="Nama Mata Pelajaran">
                                    <button onclick="window.addSub()" class="md:col-span-3 btn-primary text-white rounded-3xl font-black text-[12px] uppercase tracking-[0.2em]">Tambah</button>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
                                ${window.appState.subjects.map(s => `
                                    <div class="p-8 bg-white border-2 border-slate-200 rounded-[2.5rem] flex flex-col justify-between group shadow-sm transition-all hover:border-emerald-500">
                                        <div class="flex items-center gap-6 mb-8">
                                            <div class="text-5xl transform group-hover:scale-110 transition-transform">${s.icon || 'üìö'}</div>
                                            <div>
                                                <div class="font-black text-2xl text-slate-900">${s.name}</div>
                                                <div class="text-[11px] font-black text-emerald-600 uppercase tracking-[0.25em] mt-2">${s.chapters?.length || 0} BAB</div>
                                            </div>
                                        </div>
                                        <div class="flex gap-3">
                                            <button onclick="window.manageBab('${s.id}')" class="flex-grow py-4 bg-slate-900 text-white rounded-2xl text-[12px] font-black uppercase tracking-widest hover:bg-emerald-600 transition-all">Isi Materi</button>
                                            <button onclick="window.deleteSub('${s.id}')" class="p-4 bg-red-50 border-2 border-red-100 text-red-400 rounded-2xl hover:bg-red-500 hover:text-white transition-all">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <div id="bab-management-area"></div>

                <div class="glass p-12 rounded-[3.5rem] card-shadow">
                    <div class="flex justify-between items-center mb-10">
                        <div>
                            <h2 class="font-black text-3xl text-slate-900 tracking-tighter">Absensi Siswa</h2>
                            <p class="text-[11px] font-black text-slate-400 uppercase tracking-[0.3em] mt-2">Daftar kehadiran siswa secara realtime</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-black text-slate-400 uppercase tracking-widest">Total Siswa:</span>
                            <span class="bg-emerald-500 text-white px-6 py-2 rounded-2xl text-lg font-black" id="att-count">0</span>
                        </div>
                    </div>

                    <div class="table-container custom-scroll">
                        <table id="attendance-table">
                            <thead>
                                <tr>
                                    <th>Hari / Tanggal</th>
                                    <th>Waktu (WIB)</th>
                                    <th>Nama Siswa</th>
                                    <th>Kelas</th>
                                    <th>Provinsi</th>
                                    <th>Asal Sekolah</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-list-horizontal">
                                <!-- Data akan diupdate oleh updateAttendanceUI() -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
            
            // Panggil pengisian data awal
            window.updateAttendanceUI();
        }

        // Fungsi Update UI khusus untuk Tabel Absensi (Tanpa Re-render seluruh page)
        window.updateAttendanceUI = () => {
            const list = document.getElementById('attendance-list-horizontal');
            const count = document.getElementById('att-count');
            if (!list) return;

            const data = window.appState.attendance;
            count.innerText = data.length;
            
            list.innerHTML = data.map(d => {
                const dt = new Date(d.timestamp);
                const dateStr = dt.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const timeStr = dt.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                
                return `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="font-bold text-slate-600">${dateStr}</td>
                    <td class="font-black text-emerald-600">${timeStr}</td>
                    <td class="font-black text-slate-900">${d.nama}</td>
                    <td class="font-bold text-indigo-600">${d.kelas || '-'}</td>
                    <td class="font-medium text-slate-500">${d.provinsi || '-'}</td>
                    <td class="font-extrabold text-slate-700">${d.sekolah}</td>
                </tr>`;
            }).join('') || '<tr><td colspan="6" class="text-center text-slate-300 py-16 font-bold italic">Belum ada data absensi.</td></tr>';
        };

        window.checkAdmin = () => {
            const pw = document.getElementById('admin-pw').value;
            if (pw === 'admin123') {
                window.appState.isAdminLoggedIn = true;
                sessionStorage.setItem('admin_session', 'active');
                window.renderApp();
            } else { window.showNotify("Password Salah!"); }
        };

        window.adminLogout = () => {
            window.appState.isAdminLoggedIn = false;
            sessionStorage.removeItem('admin_session');
            window.renderApp();
        };

        window.addSub = async () => {
            const name = document.getElementById('new-sub-name').value;
            const icon = document.getElementById('new-sub-icon').value;
            if (name && window.db) {
                await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects'), { 
                    name, icon, chapters: [], createdAt: window.serverTimestamp()
                });
                document.getElementById('new-sub-name').value = '';
            }
        };

        window.deleteSub = async (id) => {
            if (confirm("Hapus mata pelajaran ini?")) {
                await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', id));
            }
        };

        window.manageBab = (id) => {
            const subject = window.appState.subjects.find(s => s.id === id);
            const area = document.getElementById('bab-management-area');
            if (!area) return;

            area.innerHTML = `
            <div class="glass p-12 rounded-[3.5rem] card-shadow border-emerald-500 animate-in slide-in-from-bottom-8 duration-500">
                <div class="flex justify-between items-start mb-14">
                    <div>
                        <h3 class="font-black text-4xl text-slate-900 tracking-tighter">${subject.name}</h3>
                        <p class="text-[11px] font-black text-emerald-600 uppercase tracking-[0.4em] mt-3">Edit Materi Pembelajaran</p>
                    </div>
                    <button onclick="document.getElementById('bab-management-area').innerHTML=''" class="w-12 h-12 bg-slate-100 border-2 border-slate-200 rounded-2xl flex items-center justify-center text-slate-400 hover:text-red-500 transition-all text-xl">‚úï</button>
                </div>

                <div class="bg-white p-8 rounded-[2.5rem] border-2 border-dashed border-slate-300 mb-14">
                    <div class="flex gap-5">
                        <input id="new-bab-name" class="flex-grow p-6 border-2 border-slate-200 rounded-2xl font-black text-lg" placeholder="Ketik Judul BAB Baru...">
                        <button onclick="window.addBab('${id}')" class="bg-slate-900 text-white px-10 rounded-2xl font-black text-[12px] uppercase tracking-[0.2em]">Tambah BAB</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    ${(subject.chapters || []).map((ch, idx) => `
                        <div class="p-10 bg-white rounded-[3rem] border-2 border-slate-100 relative shadow-sm">
                            <div class="flex justify-between items-center mb-8 border-b-2 border-slate-50 pb-4">
                                <div class="font-black text-xl text-slate-900 tracking-tight">BAB ${idx+1}</div>
                                <button onclick="window.deleteBab('${id}', ${idx})" class="text-red-300 hover:text-red-500 transition-colors">‚úï</button>
                            </div>
                            <h4 class="font-black text-slate-700 text-lg mb-8 leading-snug">${ch.title}</h4>
                            
                            <div class="space-y-3 mb-10">
                                ${(ch.topics || []).map((t, tidx) => `
                                    <div class="flex justify-between items-center bg-slate-50 p-5 rounded-2xl border-2 border-white shadow-sm">
                                        <div class="font-bold text-slate-800 text-sm truncate mr-4">${t.title}</div>
                                        <button onclick="window.deleteTopic('${id}', ${idx}, ${tidx})" class="text-slate-300 hover:text-red-400 font-black">‚úï</button>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="space-y-4 pt-6 border-t-2 border-slate-50">
                                <input id="topic-title-${idx}" class="w-full p-5 border-2 border-slate-100 rounded-2xl text-sm font-bold" placeholder="Nama Materi (Misal: Luas Persegi)">
                                <input id="topic-link-${idx}" class="w-full p-5 border-2 border-slate-100 rounded-2xl text-sm font-bold" placeholder="Link Video/Drive">
                                <button onclick="window.addTopic('${id}', ${idx})" class="w-full bg-emerald-500 text-white p-5 rounded-2xl font-black text-[11px] uppercase tracking-[0.2em] hover:bg-slate-900 transition-all">Simpan Konten</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        };

        window.addBab = async (subId) => {
            const titleInput = document.getElementById('new-bab-name');
            const title = titleInput.value;
            if (!title) return;
            const subject = window.appState.subjects.find(s => s.id === subId);
            const chapters = subject.chapters || [];
            chapters.push({ title, topics: [] });
            await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', subId), { chapters });
            titleInput.value = '';
            window.manageBab(subId);
        };

        window.deleteBab = async (subId, idx) => {
            if (!confirm("Hapus BAB?")) return;
            const subject = window.appState.subjects.find(s => s.id === subId);
            const chapters = subject.chapters;
            chapters.splice(idx, 1);
            await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', subId), { chapters });
            window.manageBab(subId);
        };

        window.addTopic = async (subId, babIdx) => {
            const titleInput = document.getElementById(`topic-title-${babIdx}`);
            const linkInput = document.getElementById(`topic-link-${babIdx}`);
            const title = titleInput.value;
            const link = linkInput.value;
            if (!title) return;
            const subject = window.appState.subjects.find(s => s.id === subId);
            const chapters = [...(subject.chapters || [])];
            if (!chapters[babIdx].topics) chapters[babIdx].topics = [];
            chapters[babIdx].topics.push({ title, link: link || '#' });
            await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', subId), { chapters });
            titleInput.value = ''; linkInput.value = '';
            window.manageBab(subId);
        };

        window.deleteTopic = async (subId, babIdx, topicIdx) => {
            const subject = window.appState.subjects.find(s => s.id === subId);
            const chapters = subject.chapters;
            chapters[babIdx].topics.splice(topicIdx, 1);
            await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', subId), { chapters });
            window.manageBab(subId);
        };

        window.onload = () => { if (!window.currentUser) window.renderApp(); };
    </script>
</body>
</html>
