<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rumah Belajar Kelas 5 - Cikgu Tere</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --accent: #10b981;
            --accent-soft: #ecfdf5;
            --bg-main: #fcfdfe;
            --border-solid: #cbd5e1;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%);
            color: #0f172a;
            font-size: 18px; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 2px solid var(--border-solid);
        }

        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
        }

        .input-elegant {
            background: #ffffff;
            border: 2px solid var(--border-solid);
            transition: all 0.2s ease-in-out;
            font-size: 1rem;
        }

        .input-elegant:focus {
            background: white;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px -5px rgba(15, 23, 42, 0.25);
        }

        .loader {
            border: 4px solid #f1f5f9;
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #app-container.visible { display: block !important; }

        .tab-active {
            background: white;
            color: var(--accent);
            border: 2px solid var(--accent);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 1rem;
            border: 1px solid var(--border-solid);
        }

        th {
            background-color: #f8fafc;
            color: #64748b;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.7rem;
            padding: 1rem;
            text-align: left;
            border-bottom: 2px solid var(--border-solid);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            background-color: white;
            font-size: 0.85rem;
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, query, onSnapshot, getDoc, updateDoc, deleteDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase functions
        window.collection = collection; window.doc = doc; window.setDoc = setDoc; window.query = query;
        window.onSnapshot = onSnapshot; window.getDoc = getDoc; window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc; window.addDoc = addDoc; window.serverTimestamp = serverTimestamp;

        const manualFirebaseConfig = {
            apiKey: "AIzaSyD8mRXy6oyNpHQ6uJ_xX8YS8spWYU0wXTg",
            authDomain: "rumah-belajar-kls-5.firebaseapp.com",
            projectId: "rumah-belajar-kls-5",
            storageBucket: "rumah-belajar-kls-5.firebasestorage.app",
            messagingSenderId: "69406397949",
            appId: "1:69406397949:web:3d0edd30e5bf273b623594"
        };

        let firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : manualFirebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.hideLoading = () => {
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('app-container').classList.add('visible');
            window.renderApp();
        };

        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                
                onAuthStateChanged(window.auth, (user) => {
                    window.currentUser = user;
                    if (user) {
                        console.log("Authenticated as:", user.uid);
                        window.startDataListeners();
                    }
                    window.hideLoading();
                });

                const initAuth = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(window.auth, initialAuthToken);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    } catch (e) {
                        console.error("Auth Error:", e);
                        window.showNotify("Koneksi gagal. Periksa sinyal Anda.");
                        window.hideLoading();
                    }
                };
                initAuth();
            } catch (err) { 
                console.error("Firebase Init Error:", err);
                window.hideLoading(); 
            }
        }
    </script>
</head>
<body class="antialiased">
    <div id="loading-overlay" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[9999]">
        <div class="loader mb-4"></div>
        <h1 class="text-xl font-bold">Menghubungkan...</h1>
    </div>

    <div id="app-container" class="hidden flex-grow">
        <header class="sticky top-0 z-50 px-4 py-4">
            <div class="max-w-7xl mx-auto flex flex-col lg:flex-row justify-between items-center gap-4 glass p-4 rounded-3xl card-shadow">
                <div class="flex items-center gap-4 cursor-pointer" onclick="window.goBackToSubjects()">
                    <div class="w-12 h-12 bg-emerald-500 rounded-2xl flex items-center justify-center text-2xl shadow-lg">üè†</div>
                    <div>
                        <h1 class="text-xl font-black text-slate-900 tracking-tight">Rumah Belajar Kelas 5</h1>
                        <p class="text-[10px] font-bold text-emerald-600 uppercase tracking-widest">Cikgu Tere</p>
                    </div>
                </div>
                <nav id="tabs" class="flex p-1 bg-slate-100 rounded-2xl border border-slate-200"></nav>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-6">
            <div id="content-container"></div>
        </main>
    </div>

    <script>
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        window.appState = {
            activeTab: 'login',
            subjects: [],
            attendance: [],
            studentProfile: JSON.parse(localStorage.getItem('student_profile')) || null,
            isAdminLoggedIn: sessionStorage.getItem('admin_session') === 'active',
            viewingSubject: null,
            adminView: 'attendance'
        };

        window.startDataListeners = () => {
            if (!window.db || !window.currentUser) return;
            
            // Listen Subjects
            const qSub = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects');
            window.onSnapshot(qSub, (snap) => {
                window.appState.subjects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.renderApp();
            }, (err) => console.error("Firestore Subjects Error:", err));

            // Listen Attendance
            const qAtt = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'attendance');
            window.onSnapshot(qAtt, (snap) => {
                window.appState.attendance = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.appState.attendance.sort((a,b) => (b.serverTime?.toMillis() || 0) - (a.serverTime?.toMillis() || 0));
                window.renderApp();
            }, (err) => console.error("Firestore Attendance Error:", err));
        };

        window.renderApp = () => {
            const tabsContainer = document.getElementById('tabs');
            const container = document.getElementById('content-container');
            if (!tabsContainer || !container) return;

            const tabs = [
                { id: 'login', label: 'Masuk' },
                { id: 'mapel', label: 'Pelajaran' },
                { id: 'admin', label: 'Dashboard Guru' }
            ];
            
            tabsContainer.innerHTML = tabs.map(t => `
                <button onclick="window.switchTab('${t.id}')" class="px-6 py-2 rounded-xl text-[12px] font-bold tracking-wider uppercase transition-all ${window.appState.activeTab === t.id ? 'tab-active shadow-sm' : 'text-slate-400'}">
                    ${t.label}
                </button>
            `).join('');

            if (window.appState.activeTab === 'login') renderLogin(container);
            else if (window.appState.activeTab === 'mapel') renderMapel(container);
            else if (window.appState.activeTab === 'admin') renderAdmin(container);
        };

        window.switchTab = (tab) => { 
            if (tab === 'mapel' && !window.appState.studentProfile) {
                window.showNotify("Silakan absen dulu!");
                window.appState.activeTab = 'login';
            } else {
                window.appState.activeTab = tab; 
                window.appState.viewingSubject = null;
            }
            window.renderApp(); 
        };

        window.showNotify = (msg) => {
            const div = document.createElement('div');
            div.className = "fixed top-5 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-xl font-bold shadow-2xl z-[9999]";
            div.innerText = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        };

        window.goBackToSubjects = () => { 
            window.appState.viewingSubject = null;
            window.switchTab('mapel'); 
        };

        function renderLogin(container) {
            if (window.appState.studentProfile) {
                container.innerHTML = `
                <div class="max-w-lg mx-auto glass p-10 rounded-[2rem] card-shadow text-center">
                    <div class="text-5xl mb-6">üëã</div>
                    <h2 class="text-2xl font-black text-slate-900">Halo, ${window.appState.studentProfile.nama}!</h2>
                    <p class="text-slate-500 mt-2 mb-8 italic">${window.appState.studentProfile.sekolah}</p>
                    <button onclick="window.switchTab('mapel')" class="w-full btn-primary text-white py-4 rounded-2xl font-bold uppercase tracking-widest mb-4">Mulai Belajar</button>
                    <button onclick="localStorage.removeItem('student_profile'); window.appState.studentProfile=null; window.renderApp();" class="text-xs text-slate-400 font-bold underline">Ganti Nama</button>
                </div>`;
            } else {
                container.innerHTML = `
                <div class="max-w-lg mx-auto glass p-8 rounded-[2rem] card-shadow">
                    <h2 class="text-2xl font-black text-center mb-6">Absensi Siswa</h2>
                    <div class="space-y-4">
                        <input id="s-nama" class="input-elegant w-full p-4 rounded-xl font-bold" placeholder="Nama Lengkap">
                        <input id="s-sekolah" class="input-elegant w-full p-4 rounded-xl font-bold" placeholder="Asal Sekolah">
                        <select id="s-kelas" class="input-elegant w-full p-4 rounded-xl font-bold">
                            <option value="5A">Kelas 5A</option>
                            <option value="5B">Kelas 5B</option>
                            <option value="5C">Kelas 5C</option>
                        </select>
                        <button id="btn-absen" onclick="window.saveProfile()" class="w-full btn-primary text-white py-4 rounded-xl font-black uppercase tracking-widest shadow-lg">Masuk Kelas</button>
                    </div>
                </div>`;
            }
        }

        window.saveProfile = async () => {
            const nama = document.getElementById('s-nama').value.trim();
            const sekolah = document.getElementById('s-sekolah').value.trim();
            const kelas = document.getElementById('s-kelas').value;
            const btn = document.getElementById('btn-absen');

            if (!nama || !sekolah) return window.showNotify("Harap isi nama dan sekolah!");
            
            // Cek apakah Firebase sudah siap
            if (!window.currentUser || !window.db) {
                return window.showNotify("Masih menghubungkan ke server, coba lagi sebentar...");
            }

            try {
                btn.disabled = true;
                btn.innerText = "MENGIRIM...";
                
                const profile = { 
                    nama, 
                    sekolah, 
                    kelas, 
                    uid: window.currentUser.uid,
                    timestamp: new Date().toISOString() 
                };

                // Path sesuai MANDATORY RULE 1
                await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'attendance'), { 
                    ...profile, 
                    serverTime: window.serverTimestamp() 
                });

                localStorage.setItem('student_profile', JSON.stringify(profile));
                window.appState.studentProfile = profile;
                window.showNotify("Berhasil Absen!");
                window.renderApp();
            } catch(e) { 
                console.error("Save Error:", e);
                window.showNotify("Gagal terhubung ke database. Coba lagi."); 
                btn.disabled = false;
                btn.innerText = "MASUK KELAS";
            }
        };

        function renderMapel(container) {
            if (window.appState.viewingSubject) {
                const s = window.appState.viewingSubject;
                container.innerHTML = `
                <div class="mb-6 flex items-center gap-4">
                    <button onclick="window.goBackToSubjects()" class="p-3 glass rounded-xl">‚¨ÖÔ∏è</button>
                    <h2 class="text-2xl font-black">${s.name}</h2>
                </div>
                <div class="space-y-6">
                    ${(s.chapters || []).map((ch, idx) => `
                        <div class="glass p-6 rounded-3xl card-shadow">
                            <h3 class="font-bold text-lg mb-4 text-emerald-600">BAB ${idx+1}: ${ch.title}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                ${(ch.topics || []).map(t => `
                                    <a href="${t.link}" target="_blank" class="p-4 bg-white border border-slate-100 rounded-xl hover:border-emerald-500 transition-all flex items-center gap-3">
                                        <span>üìñ</span> <span class="font-medium text-slate-700">${t.title}</span>
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    `).join(s.chapters?.length ? '' : '<p class="text-center text-slate-400 py-10">Materi belum ada.</p>')}
                </div>`;
                return;
            }

            container.innerHTML = `
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                ${window.appState.subjects.map(s => `
                    <div onclick="window.openSubject('${s.id}')" class="glass p-8 rounded-[2rem] card-shadow text-center cursor-pointer hover:scale-105 transition-transform">
                        <div class="text-5xl mb-4">${s.icon || 'üìö'}</div>
                        <h3 class="font-black text-xl">${s.name}</h3>
                    </div>
                `).join('')}
                ${window.appState.subjects.length === 0 ? '<p class="col-span-full text-center py-20 text-slate-400 italic">Memuat materi...</p>' : ''}
            </div>`;
        }

        window.openSubject = (id) => {
            window.appState.viewingSubject = window.appState.subjects.find(s => s.id === id);
            window.renderApp();
        };

        function renderAdmin(container) {
            if (!window.appState.isAdminLoggedIn) {
                container.innerHTML = `
                <div class="max-w-md mx-auto glass p-10 rounded-[2rem] card-shadow text-center">
                    <h2 class="text-xl font-black mb-6">Login Guru</h2>
                    <input id="admin-pw" type="password" class="input-elegant w-full p-4 rounded-xl text-center mb-4" placeholder="Sandi">
                    <button onclick="window.checkAdmin()" class="w-full btn-primary text-white py-4 rounded-xl font-bold">Masuk</button>
                </div>`;
                return;
            }

            container.innerHTML = `
            <div class="space-y-6">
                <div class="flex flex-col sm:flex-row justify-between items-center glass p-6 rounded-3xl gap-4 shadow-sm">
                    <div class="flex gap-2 bg-slate-100 p-1.5 rounded-2xl">
                        <button onclick="window.setAdminView('attendance')" class="px-6 py-2.5 rounded-xl font-black text-xs tracking-widest uppercase transition-all ${window.appState.adminView === 'attendance' ? 'bg-white shadow-md text-emerald-600' : 'text-slate-400'}">Data Absensi</button>
                        <button onclick="window.setAdminView('manage')" class="px-6 py-2.5 rounded-xl font-black text-xs tracking-widest uppercase transition-all ${window.appState.adminView === 'manage' ? 'bg-white shadow-md text-emerald-600' : 'text-slate-400'}">Kelola Pelajaran</button>
                    </div>
                    <button onclick="window.adminLogout()" class="bg-red-50 text-red-500 px-4 py-2 rounded-xl font-bold text-xs hover:bg-red-100 transition-colors">Logout</button>
                </div>
                ${window.appState.adminView === 'attendance' ? renderAdminAttendance() : renderAdminManage()}
            </div>`;
        }

        function renderAdminAttendance() {
            return `
            <div class="glass p-8 rounded-[2.5rem] card-shadow overflow-hidden">
                <h3 class="font-black text-xl mb-6">Daftar Kehadiran (${window.appState.attendance.length})</h3>
                <div class="table-container custom-scroll">
                    <table class="w-full">
                        <thead><tr><th>Waktu</th><th>Nama</th><th>Kelas</th><th>Sekolah</th></tr></thead>
                        <tbody>
                            ${window.appState.attendance.map(a => `
                                <tr>
                                    <td class="text-[10px] text-slate-400">${a.serverTime?.toDate().toLocaleString('id-ID') || '-'}</td>
                                    <td class="font-black text-slate-800">${a.nama}</td>
                                    <td class="font-bold text-emerald-600 uppercase text-xs">${a.kelas || '-'}</td>
                                    <td class="text-slate-500 text-sm">${a.sekolah}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
        }

        function renderAdminManage() {
            return `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="glass p-8 rounded-[2.5rem] card-shadow">
                    <h3 class="font-black text-lg mb-6">Mapel Baru</h3>
                    <div class="space-y-4">
                        <input id="new-mapel-name" class="input-elegant w-full p-4 rounded-xl" placeholder="Nama Pelajaran">
                        <input id="new-mapel-icon" class="input-elegant w-full p-4 rounded-xl" placeholder="Ikon Emoji">
                        <button onclick="window.addMapel()" class="w-full btn-primary text-white py-4 rounded-xl font-black">TAMBAH MAPEL</button>
                    </div>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    ${window.appState.subjects.map(s => `
                        <div class="glass p-8 rounded-[2.5rem] card-shadow">
                            <div class="flex justify-between items-center mb-6">
                                <div class="flex items-center gap-4">
                                    <span class="text-4xl">${s.icon}</span>
                                    <h4 class="font-black text-xl">${s.name}</h4>
                                </div>
                                <button onclick="window.deleteMapel('${s.id}')" class="text-red-400">Hapus</button>
                            </div>
                            <div class="space-y-4">
                                ${(s.chapters || []).map((ch, chIdx) => `
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100">
                                        <div class="flex justify-between mb-2">
                                            <span class="font-bold text-sm">BAB ${chIdx+1}: ${ch.title}</span>
                                            <button onclick="window.removeBab('${s.id}', ${chIdx})" class="text-xs text-red-300">√ó</button>
                                        </div>
                                        <div class="space-y-2 mb-4">
                                            ${(ch.topics || []).map((t, tIdx) => `
                                                <div class="flex justify-between text-xs bg-slate-50 p-2 rounded">
                                                    <span>${t.title}</span>
                                                    <button onclick="window.removeTopic('${s.id}', ${chIdx}, ${tIdx})">√ó</button>
                                                </div>
                                            `).join('')}
                                        </div>
                                        <div class="flex gap-2">
                                            <input id="topic-t-${s.id}-${chIdx}" class="flex-1 p-2 bg-slate-50 rounded text-xs" placeholder="Judul">
                                            <input id="topic-l-${s.id}-${chIdx}" class="flex-1 p-2 bg-slate-50 rounded text-xs" placeholder="Link">
                                            <button onclick="window.addTopic('${s.id}', ${chIdx})" class="bg-emerald-500 text-white px-3 rounded text-xs">Simpan</button>
                                        </div>
                                    </div>
                                `).join('')}
                                <div class="flex gap-2 mt-4">
                                    <input id="bab-title-${s.id}" class="flex-1 p-3 border rounded-xl" placeholder="Judul BAB Baru">
                                    <button onclick="window.addBab('${s.id}')" class="bg-slate-900 text-white px-4 rounded-xl text-xs font-bold">TAMBAH BAB</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        }

        window.setAdminView = (v) => { window.appState.adminView = v; window.renderApp(); };

        window.addMapel = async () => {
            const name = document.getElementById('new-mapel-name').value;
            const icon = document.getElementById('new-mapel-icon').value || 'üìö';
            if (!name) return;
            await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects'), { name, icon, chapters: [] });
            document.getElementById('new-mapel-name').value = '';
            window.showNotify("Mapel ditambahkan!");
        };

        window.deleteMapel = async (id) => {
            if (confirm("Hapus mapel ini?")) await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', id));
        };

        window.addBab = async (sId) => {
            const input = document.getElementById(`bab-title-${sId}`);
            const title = input.value;
            if (!title) return;
            const sRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', sId);
            const chapters = [...(window.appState.subjects.find(s => s.id === sId).chapters || []), { title, topics: [] }];
            await window.updateDoc(sRef, { chapters });
            input.value = '';
        };

        window.removeBab = async (sId, idx) => {
            const sRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', sId);
            const chapters = [...window.appState.subjects.find(s => s.id === sId).chapters];
            chapters.splice(idx, 1);
            await window.updateDoc(sRef, { chapters });
        };

        window.addTopic = async (sId, chIdx) => {
            const t = document.getElementById(`topic-t-${sId}-${chIdx}`).value;
            const l = document.getElementById(`topic-l-${sId}-${chIdx}`).value;
            if (!t || !l) return;
            const sRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', sId);
            const chapters = JSON.parse(JSON.stringify(window.appState.subjects.find(s => s.id === sId).chapters));
            chapters[chIdx].topics.push({ title: t, link: l });
            await window.updateDoc(sRef, { chapters });
        };

        window.removeTopic = async (sId, chIdx, tIdx) => {
            const sRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects', sId);
            const chapters = JSON.parse(JSON.stringify(window.appState.subjects.find(s => s.id === sId).chapters));
            chapters[chIdx].topics.splice(tIdx, 1);
            await window.updateDoc(sRef, { chapters });
        };

        window.checkAdmin = () => {
            if (document.getElementById('admin-pw').value === 'admin123') {
                window.appState.isAdminLoggedIn = true;
                sessionStorage.setItem('admin_session', 'active');
                window.renderApp();
            } else { window.showNotify("Sandi salah!"); }
        };

        window.adminLogout = () => {
            window.appState.isAdminLoggedIn = false;
            sessionStorage.removeItem('admin_session');
            window.renderApp();
        };

        window.switchTab('login');
    </script>
</body>
</html>
