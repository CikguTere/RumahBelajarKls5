<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rumah Belajar Kelas 5 - Cikgu Tere</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --accent: #10b981;
            --accent-soft: #ecfdf5;
            --bg-main: #fcfdfe;
            --border-solid: #cbd5e1;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%);
            color: #0f172a;
            font-size: 18px; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 2px solid var(--border-solid);
        }

        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
        }

        .input-elegant {
            background: #ffffff;
            border: 2px solid var(--border-solid);
            transition: all 0.2s ease-in-out;
            font-size: 1.1rem;
        }

        .input-elegant:focus {
            background: white;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px -5px rgba(15, 23, 42, 0.25);
        }

        .loader {
            border: 4px solid #f1f5f9;
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #app-container.visible { display: block !important; }

        .tab-active {
            background: white;
            color: var(--accent);
            border: 2px solid var(--accent);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 1.5rem;
            border: 2px solid var(--border-solid);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background-color: #f8fafc;
            color: #64748b;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            padding: 1.25rem 1.5rem;
            text-align: left;
            border-bottom: 2px solid var(--border-solid);
        }

        td {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #f1f5f9;
            background-color: white;
            font-size: 0.95rem;
            color: #1e293b;
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, query, onSnapshot, getDoc, updateDoc, arrayUnion, deleteDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase functions
        window.collection = collection; window.doc = doc; window.setDoc = setDoc; window.query = query;
        window.onSnapshot = onSnapshot; window.getDoc = getDoc; window.updateDoc = updateDoc;
        window.arrayUnion = arrayUnion; window.deleteDoc = deleteDoc; window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.hideLoading = () => {
            const overlay = document.getElementById('loading-overlay');
            const app = document.getElementById('app-container');
            if (overlay) overlay.style.opacity = '0';
            setTimeout(() => {
                if (overlay) overlay.style.display = 'none';
                if (app) app.classList.add('visible');
                window.renderApp();
            }, 500);
        };

        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                
                onAuthStateChanged(window.auth, (user) => {
                    window.currentUser = user;
                    if (user) {
                        // Jalankan listener segera setelah auth berhasil
                        window.startDataListeners();
                    }
                    window.hideLoading();
                });

                const initAuth = async () => {
                    if (initialAuthToken) await signInWithCustomToken(window.auth, initialAuthToken);
                    else await signInAnonymously(window.auth);
                };
                initAuth().catch(() => window.hideLoading());
            } catch (err) { window.hideLoading(); }
        } else { setTimeout(window.hideLoading, 800); }
    </script>
</head>
<body class="antialiased">
    <div id="loading-overlay" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[9999] transition-opacity duration-500">
        <div class="loader mb-4"></div>
        <h1 class="text-2xl font-black text-slate-900 tracking-tight">Menghubungkan ke Server...</h1>
    </div>

    <div id="app-container" class="hidden flex-grow">
        <header class="sticky top-0 z-50 px-4 md:px-6 py-4">
            <div class="max-w-7xl mx-auto flex flex-col lg:flex-row justify-between items-center gap-6 glass p-5 rounded-[2.5rem] card-shadow">
                <div class="flex items-center gap-5 cursor-pointer group" onclick="window.goBackToSubjects()">
                    <div class="w-14 h-14 bg-emerald-500 rounded-[1.25rem] flex items-center justify-center text-3xl shadow-lg shadow-emerald-200 group-hover:rotate-6 transition-transform">üè†</div>
                    <div class="overflow-hidden">
                        <h1 class="text-2xl md:text-3xl font-black text-slate-900 tracking-tighter leading-none whitespace-nowrap">Rumah Belajar Kelas 5</h1>
                        <p class="text-[11px] font-extrabold text-emerald-600 uppercase tracking-[0.25em] mt-1.5">Platform Belajar Cikgu Tere</p>
                    </div>
                </div>
                
                <nav id="tabs" class="flex p-2 bg-slate-100 rounded-[1.5rem] w-full lg:w-auto overflow-x-auto border-2 border-slate-200"></nav>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-6 py-8 md:py-12">
            <div id="content-container"></div>
        </main>
    </div>

    <footer class="py-10 text-center">
        <div class="max-w-7xl mx-auto px-6">
            <p class="text-slate-500 font-medium text-sm tracking-wide">
                &copy; 2025 Ruang Digital Kelas 5 ‚Ä¢ <span class="text-slate-900 font-bold">Cikgu Tere</span>
            </p>
        </div>
    </footer>

    <script>
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        window.appState = {
            activeTab: 'login',
            subjects: [],
            attendance: [],
            studentProfile: JSON.parse(localStorage.getItem('student_profile')) || null,
            isAdminLoggedIn: false, // Reset setiap reload untuk keamanan
            viewingSubject: null
        };

        // Cek status admin dari sessionStorage saat start
        if (sessionStorage.getItem('admin_session') === 'active') {
            window.appState.isAdminLoggedIn = true;
        }

        window.startDataListeners = () => {
            if (!window.db || window.listenerActive) return;
            window.listenerActive = true;
            
            // Listener Pelajaran
            const qSub = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects');
            window.onSnapshot(qSub, (snap) => {
                window.appState.subjects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.renderApp();
            });

            // Listener Absensi (Global Real-time)
            const qAtt = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'attendance');
            window.onSnapshot(qAtt, (snap) => {
                window.appState.attendance = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Urutkan berdasarkan waktu terbaru
                window.appState.attendance.sort((a,b) => {
                    const timeA = a.serverTime?.seconds || new Date(a.timestamp).getTime() / 1000;
                    const timeB = b.serverTime?.seconds || new Date(b.timestamp).getTime() / 1000;
                    return timeB - timeA;
                });
                
                // Update UI tabel jika sedang di halaman admin
                if (window.appState.activeTab === 'admin' && window.appState.isAdminLoggedIn) {
                    window.updateAttendanceUI();
                }
            });
        };

        window.renderApp = () => {
            const tabsContainer = document.getElementById('tabs');
            const container = document.getElementById('content-container');
            if (!tabsContainer || !container) return;

            const tabs = [
                { id: 'login', label: 'Masuk' },
                { id: 'mapel', label: 'Pelajaran' },
                { id: 'admin', label: 'Dashboard' }
            ];
            
            tabsContainer.innerHTML = tabs.map(t => `
                <button onclick="window.switchTab('${t.id}')" class="flex-1 lg:flex-none whitespace-nowrap px-8 py-3 rounded-2xl text-[13px] font-black tracking-widest uppercase transition-all ${window.appState.activeTab === t.id ? 'tab-active' : 'text-slate-400 hover:text-slate-600'}">
                    ${t.label}
                </button>
            `).join('');

            if (window.appState.activeTab === 'login') renderLogin(container);
            else if (window.appState.activeTab === 'mapel') renderMapel(container);
            else if (window.appState.activeTab === 'admin') renderAdmin(container);
        };

        window.switchTab = (tab) => { 
            if (tab === 'mapel' && !window.appState.studentProfile) {
                window.showNotify("Harap isi data diri dulu!");
                window.appState.activeTab = 'login';
            } else {
                window.appState.activeTab = tab; 
                window.appState.viewingSubject = null;
            }
            window.renderApp(); 
        };

        window.showNotify = (msg) => {
            const div = document.createElement('div');
            div.className = "fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-2xl font-bold shadow-2xl z-[9999] animate-bounce";
            div.innerText = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 2500);
        };

        window.goBackToSubjects = () => { 
            window.appState.viewingSubject = null;
            window.switchTab('mapel'); 
        };

        function renderLogin(container) {
            if (window.appState.studentProfile) {
                container.innerHTML = `
                <div class="max-w-xl mx-auto glass p-12 rounded-[3rem] card-shadow text-center">
                    <div class="w-24 h-24 bg-emerald-100 rounded-3xl flex items-center justify-center text-5xl mx-auto mb-8 shadow-sm">üåü</div>
                    <h2 class="text-3xl font-black text-slate-900 tracking-tight">Halo, <span class="text-emerald-600">${window.appState.studentProfile.nama}</span>!</h2>
                    <p class="text-slate-500 mt-4 mb-10 font-medium">Kamu sudah terdaftar di <b>${window.appState.studentProfile.sekolah}</b>.</p>
                    <div class="flex flex-col gap-4">
                        <button onclick="window.switchTab('mapel')" class="btn-primary text-white p-6 rounded-2xl font-black uppercase tracking-widest">Mulai Belajar</button>
                        <button onclick="localStorage.removeItem('student_profile'); window.appState.studentProfile=null; window.renderApp();" class="text-slate-400 hover:text-red-500 font-bold text-sm underline">Ganti Akun Siswa</button>
                    </div>
                </div>`;
            } else {
                container.innerHTML = `
                <div class="max-w-xl mx-auto glass p-10 rounded-[3rem] card-shadow">
                    <h2 class="text-3xl font-black text-slate-900 text-center mb-8">Presensi Siswa</h2>
                    <div class="space-y-6">
                        <input id="s-nama" class="input-elegant w-full p-5 rounded-2xl font-bold" placeholder="Nama Lengkap">
                        <div class="grid grid-cols-2 gap-4">
                            <input id="s-prov" class="input-elegant w-full p-5 rounded-2xl font-bold" placeholder="Provinsi">
                            <select id="s-kelas" class="input-elegant w-full p-5 rounded-2xl font-bold">
                                <option value="5A">Kelas 5A</option>
                                <option value="5B">Kelas 5B</option>
                                <option value="5C">Kelas 5C</option>
                            </select>
                        </div>
                        <input id="s-sekolah" class="input-elegant w-full p-5 rounded-2xl font-bold" placeholder="Asal Sekolah">
                        <button onclick="window.saveProfile()" class="w-full btn-primary text-white p-6 rounded-2xl font-black uppercase tracking-widest shadow-lg">Masuk Kelas</button>
                    </div>
                </div>`;
            }
        }

        window.saveProfile = async () => {
            const nama = document.getElementById('s-nama').value;
            const provinsi = document.getElementById('s-prov').value;
            const sekolah = document.getElementById('s-sekolah').value;
            const kelas = document.getElementById('s-kelas').value;
            
            if (!nama || !sekolah || !provinsi) {
                window.showNotify("Data belum lengkap!"); return;
            }

            const profile = { nama, provinsi, sekolah, kelas, timestamp: new Date().toISOString() };
            if (window.db) {
                try {
                    await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'attendance'), { 
                        ...profile, serverTime: window.serverTimestamp() 
                    });
                } catch(e) { console.error(e); }
            }
            localStorage.setItem('student_profile', JSON.stringify(profile));
            window.appState.studentProfile = profile;
            window.renderApp();
        };

        function renderMapel(container) {
            if (window.appState.viewingSubject) {
                const s = window.appState.viewingSubject;
                container.innerHTML = `
                <div class="mb-10 flex items-center gap-6">
                    <button onclick="window.goBackToSubjects()" class="p-4 glass rounded-2xl hover:bg-white transition-all shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <h2 class="text-3xl font-black text-slate-900">${s.name}</h2>
                </div>
                <div class="space-y-8">
                    ${(s.chapters || []).map((ch, idx) => `
                        <div class="glass p-8 rounded-[2.5rem] card-shadow">
                            <h3 class="font-black text-2xl mb-8 border-b-2 border-slate-50 pb-4">BAB ${idx+1}: ${ch.title}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${(ch.topics || []).map(t => `
                                    <a href="${t.link || '#'}" target="_blank" class="flex items-center gap-5 p-6 bg-white border-2 border-slate-100 hover:border-emerald-500 rounded-2xl transition-all shadow-sm group">
                                        <div class="text-2xl">üìñ</div>
                                        <div class="font-bold text-slate-800 group-hover:text-emerald-600">${t.title}</div>
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>`;
                return;
            }

            container.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                    ${window.appState.subjects.map(s => `
                        <div onclick="window.openSubject('${s.id}')" class="group glass p-10 rounded-[3rem] card-shadow hover:translate-y-[-5px] transition-all cursor-pointer text-center">
                            <div class="text-7xl mb-6 group-hover:scale-110 transition-transform">${s.icon || 'üìö'}</div>
                            <h3 class="font-black text-2xl text-slate-900">${s.name}</h3>
                            <p class="text-xs font-bold text-emerald-600 mt-6 tracking-widest uppercase">Pilih Pelajaran</p>
                        </div>
                    `).join('')}
                </div>`;
        }

        window.openSubject = (id) => {
            window.appState.viewingSubject = window.appState.subjects.find(s => s.id === id);
            window.renderApp();
        };

        function renderAdmin(container) {
            if (!window.appState.isAdminLoggedIn) {
                container.innerHTML = `
                <div class="max-w-md mx-auto glass p-12 rounded-[3rem] card-shadow text-center">
                    <h2 class="text-2xl font-black text-slate-900 mb-8 uppercase tracking-tighter">Login Panel Guru</h2>
                    <input id="admin-pw" type="password" class="input-elegant w-full p-5 rounded-2xl text-center font-black text-2xl mb-6" placeholder="Password">
                    <button onclick="window.checkAdmin()" class="w-full btn-primary text-white p-5 rounded-2xl font-black uppercase tracking-widest">Masuk</button>
                </div>`;
                return;
            }

            container.innerHTML = `
            <div class="space-y-10">
                <div class="flex justify-between items-center glass p-8 rounded-[2rem] card-shadow">
                    <h2 class="font-black text-2xl">Dashboard Guru</h2>
                    <button onclick="window.adminLogout()" class="bg-red-50 text-red-500 px-6 py-2 rounded-xl font-bold text-sm">Keluar</button>
                </div>

                <div class="glass p-8 rounded-[2.5rem] card-shadow">
                    <h3 class="font-black text-xl mb-6">Tambah Mata Pelajaran</h3>
                    <div class="flex gap-4">
                        <input id="new-sub-icon" class="w-20 p-4 border-2 rounded-2xl text-center text-2xl" value="üìö">
                        <input id="new-sub-name" class="flex-grow p-4 border-2 rounded-2xl font-bold" placeholder="Nama Pelajaran">
                        <button onclick="window.addSub()" class="btn-primary text-white px-8 rounded-2xl font-black">Tambah</button>
                    </div>
                </div>

                <div class="glass p-8 rounded-[2.5rem] card-shadow">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-black text-xl">Daftar Kehadiran Siswa</h3>
                        <div class="bg-emerald-500 text-white px-4 py-1 rounded-lg font-black" id="att-count">0</div>
                    </div>
                    <div class="table-container custom-scroll border-2 border-slate-100">
                        <table>
                            <thead>
                                <tr>
                                    <th>Waktu</th>
                                    <th>Nama Siswa</th>
                                    <th>Kelas</th>
                                    <th>Sekolah</th>
                                    <th>Provinsi</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>`;
            
            window.updateAttendanceUI();
        }

        window.updateAttendanceUI = () => {
            const list = document.getElementById('attendance-list');
            const count = document.getElementById('att-count');
            if (!list) return;

            const data = window.appState.attendance;
            count.innerText = data.length;
            
            list.innerHTML = data.map(d => {
                const dt = new Date(d.timestamp);
                return `
                <tr>
                    <td class="font-bold text-slate-500 text-xs">${dt.toLocaleString('id-ID')}</td>
                    <td class="font-black text-slate-900">${d.nama}</td>
                    <td class="font-bold text-indigo-600">${d.kelas || '-'}</td>
                    <td class="font-medium text-slate-700">${d.sekolah}</td>
                    <td class="text-slate-400 text-xs">${d.provinsi || '-'}</td>
                </tr>`;
            }).join('') || '<tr><td colspan="5" class="text-center py-10 font-bold italic text-slate-300">Belum ada siswa yang masuk hari ini.</td></tr>';
        };

        window.checkAdmin = () => {
            const pw = document.getElementById('admin-pw').value;
            if (pw === 'admin123') {
                window.appState.isAdminLoggedIn = true;
                sessionStorage.setItem('admin_session', 'active');
                window.renderApp();
            } else { 
                window.showNotify("Password Salah!"); 
            }
        };

        window.adminLogout = () => {
            window.appState.isAdminLoggedIn = false;
            sessionStorage.removeItem('admin_session');
            window.renderApp();
        };

        window.addSub = async () => {
            const name = document.getElementById('new-sub-name').value;
            const icon = document.getElementById('new-sub-icon').value;
            if (name && window.db) {
                await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'subjects'), { 
                    name, icon, chapters: [], createdAt: window.serverTimestamp()
                });
                document.getElementById('new-sub-name').value = '';
            }
        };

        window.onload = () => { if (!window.currentUser) window.renderApp(); };
    </script>
</body>
</html>
